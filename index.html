<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRASIAS - ÿÆÿØŸÖÿ© ÿßŸÑŸÜŸÇŸÑ ÿßŸÑÿ∞ŸÉŸäÿ©</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      direction: rtl;
    }
    
    .page {
      display: none;
      width: 100%;
      height: 100vh;
    }
    
    .page.active {
      display: flex;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    
    .box {
      background: white;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.2);
      width: 100%;
      text-align: center;
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    h1, h2, h3 { 
      margin-bottom: 25px; 
      color: #4a5568; 
      font-weight: 600;
    }
    
    input, button, textarea, select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .choice { 
      text-align: right; 
      margin: 25px 0; 
    }
    
    .choice label { 
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      font-size: 16px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    
    .choice label:hover {
      background-color: #f7fafc;
    }
    
    .choice input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-bottom: 0;
    }
    
    .file-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }
    
    .file-input-label {
      display: block;
      padding: 15px;
      background: #f8f9fa;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .file-input-label:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .success-message, .error-message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    .success-message {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .error-message {
      background: #fed7d7;
      color: #742a2a;
    }
    
    #mapPage {
      flex-direction: row;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    #map { 
      width: 65%; 
      height: 100vh; 
    }
    
    .sidebar {
      width: 35%;
      background: #fff;
      padding: 30px;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .sidebar label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      text-align: right;
    }
    
    .driver-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .driver-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .driver-card.selected {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .driver-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .driver-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .driver-distance {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .car-info {
      color: #718096;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .driver-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .call-btn {
      background: #48bb78;
      color: white;
    }

    .call-btn:hover {
      background: #38a169;
    }

    .chat-btn {
      background: #4299e1;
      color: white;
    }

    .chat-btn:hover {
      background: #3182ce;
    }

    .select-btn {
      background: #667eea;
      color: white;
    }

    .select-btn:hover {
      background: #5a67d8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-right: 4px solid #667eea;
      z-index: 1000;
      max-width: 350px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .notification-content {
      color: #4a5568;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .notification-actions {
      display: flex;
      gap: 10px;
    }

    .accept-btn, .reject-btn {
      flex: 1;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .accept-btn {
      background: #48bb78;
      color: white;
    }

    .reject-btn {
      background: #e53e3e;
      color: white;
    }

    .chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .chat-header {
      background: #667eea;
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      max-height: 250px;
    }

    .chat-input-container {
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 0;
    }

    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 0;
      width: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.sent {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: left;
    }

    .message.received {
      background: #f7fafc;
      color: #2d3748;
      margin-right: auto;
    }

    .trip-status {
      background: #e6fffa;
      border: 1px solid #81e6d9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .trip-status.active {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    @media (max-width: 768px) {
      #mapPage {
        flex-direction: column;
      }
      
      #map {
        width: 100%;
        height: 60vh;
      }
      
      .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
      }
      
      .box {
        margin: 10px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="box">
        <h1>üöñ GRASIAS</h1>
        <h2>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿÆÿØŸÖÿ© ÿßŸÑŸÜŸÇŸÑ ÿßŸÑÿ∞ŸÉŸäÿ©</h2>
        <div class="choice">
          <label>
            <input type="radio" name="role" value="sayeq"> 
            <span>üöó ÿ≥ÿßÿ¶ŸÇ</span>
          </label>
          <label>
            <input type="radio" name="role" value="rakib"> 
            <span>üßç‚Äç‚ôÄÔ∏è ÿ±ÿßŸÉÿ®</span>
          </label>
        </div>
        <button onclick="signInWithGoogle()">üîê ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Google</button>
      </div>
    </div>
  </div>

  <!-- ÿµŸÅÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßŸÉÿ® -->
  <div id="passengerPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßŸÉÿ®</h2>
        <div class="success-message" id="passengerSuccess"></div>
        <div class="error-message" id="passengerError"></div>
        
        <input type="text" id="passengerName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ" required>
        <input type="tel" id="passengerPhone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (ŸÖÿ´ÿßŸÑ: 0612345678)" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="passengerIdCard" accept="image/*" />
          <label for="passengerIdCard" class="file-input-label">
            üìÑ ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸáŸàŸäÿ©
          </label>
        </div>
        
        <button onclick="submitPassengerInfo()">ŸÖÿ™ÿßÿ®ÿπÿ© ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <!-- ÿµŸÅÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ -->
  <div id="driverPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ</h2>
        <div class="success-message" id="driverSuccess"></div>
        <div class="error-message" id="driverError"></div>
        
        <input type="text" id="driverName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ" required>
        <input type="tel" id="driverPhone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (ŸÖÿ´ÿßŸÑ: 0612345678)" required>
        <input type="text" id="carType" placeholder="ŸÜŸàÿπ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© (ŸÖÿ´ÿßŸÑ: ÿ™ŸàŸäŸàÿ™ÿß ŸÉŸàÿ±ŸàŸÑÿß)" required>
        <input type="text" id="carColor" placeholder="ŸÑŸàŸÜ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©" required>
        <input type="text" id="plateNumber" placeholder="ÿ±ŸÇŸÖ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="driverId" accept="image/*" required>
          <label for="driverId" class="file-input-label">
            üìÑ ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸáŸàŸäÿ©
          </label>
        </div>
        
        <div class="file-input-wrapper">
          <input type="file" id="carCheck" accept="image/*" required>
          <label for="carCheck" class="file-input-label">
            üîß ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ÿßŸÑÿ™ŸÇŸÜŸä
          </label>
        </div>
        
        <button onclick="showDeclaration()">üìú ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿπŸáÿØ</button>
        <div class="declaration-box" id="declarationBox" style="display: none; text-align: right;"></div>
        <button onclick="startDriverMap()">ŸÖÿ™ÿßÿ®ÿπÿ© ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <!-- ÿµŸÅÿ≠ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© -->
  <div id="mapPage" class="page">
    <div id="map"></div>
    <div class="sidebar">
      <h3 id="sidebarTitle">üöó ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿ©</h3>
      
      <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿßŸÉÿ® -->
      <div id="passengerContent" style="display: none;">
        <label>ÿßŸÑŸàÿ¨Ÿáÿ©:</label>
        <input type="text" id="destination" placeholder="ÿ£ÿØÿÆŸÑ Ÿàÿ¨Ÿáÿ™ŸÉ (ŸÖÿ´ÿßŸÑ: ÿ¨ÿßŸÖÿπÿ© ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±)">
        
        <label>ÿπÿØÿØ ÿßŸÑÿ±ŸÉÿßÿ®:</label>
        <input type="number" id="passengers" min="1" max="8" placeholder="ÿπÿØÿØ ÿßŸÑÿ±ŸÉÿßÿ®" value="1">
        
        <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:</label>
        <textarea id="notes" placeholder="ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿÆÿßÿµÿ©..." style="height: 80px; resize: vertical;"></textarea>
        
        <div id="nearbyDrivers">
          <h4>ÿßŸÑÿ≥ÿßÿ¶ŸÇŸàŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ŸàŸÜ:</h4>
          <div id="driversList"></div>
        </div>
      </div>

      <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≥ÿßÿ¶ŸÇ -->
      <div id="driverContent" style="display: none;">
        <label>ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ:</label>
        <select id="driverStatus" onchange="updateDriverStatus()">
          <option value="available">ŸÖÿ™ÿßÿ≠</option>
          <option value="busy">ŸÖÿ¥ÿ∫ŸàŸÑ</option>
          <option value="offline">ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ</option>
        </select>
        
        <label>ÿπÿØÿØ ÿßŸÑŸÖŸÇÿßÿπÿØ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:</label>
        <input type="number" id="availableSeats" min="1" max="8" value="4">
        
        <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ:</label>
        <textarea id="driverNotes" placeholder="ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ±ŸÉÿßÿ®..." style="height: 60px;"></textarea>
      </div>
      
      <button onclick="activateRide()" id="activateBtn">üöó ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿ©</button>
      <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ÿ•ÿπÿØÿßÿØ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
      authDomain: "grasias-d7830.firebaseapp.com",
      databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "grasias-d7830",
      storageBucket: "grasias-d7830.appspot.com",
      messagingSenderId: "134413476604",
      appId: "1:134413476604:web:ab1acfa69c025218cbad79",
      measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿπÿßŸÖÿ©
    let currentUser = null;
    let currentRole = null;
    let currentMap = null;
    let currentMarker = null;
    let currentLocation = null;
    let selectedDriver = null;
    let currentTrip = null;
    let locationInterval = null;

    // ÿ¨ÿπŸÑ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäÿßŸã
    window.db = db;
    window.auth = auth;

    // ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }
    window.showPage = showPage;

    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿ¨Ÿàÿ¨ŸÑ
    window.signInWithGoogle = () => {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿØŸàÿ± ŸÇÿ®ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ");
        return;
      }
      
      currentRole = roleInput.value;

      signInWithPopup(auth, provider)
        .then((result) => {
          currentUser = result.user;
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
          const userRef = ref(db, `users/${currentUser.uid}`);
          get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const userData = snapshot.val();
              if (userData.profileComplete) {
                showPage("mapPage");
                loadMap(userData.fullName || currentUser.displayName);
              } else {
                if (userData.role === "rakib") {
                  showPage("passengerPage");
                } else {
                  showPage("driverPage");
                }
              }
            } else {
              // ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
              set(userRef, {
                name: currentUser.displayName,
                email: currentUser.email,
                role: currentRole,
                createdAt: new Date().toISOString(),
                profileComplete: false
              });
              
              if (currentRole === "rakib") {
                showPage("passengerPage");
              } else {
                showPage("driverPage");
              }
            }
          });
        })
        .catch((error) => {
          console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:", error);
          alert("ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: " + error.message);
        });
    };

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
    function loadMap(userName) {
      if (currentMap) {
        currentMap.remove();
      }
      
      currentMap = L.map('map').setView([36.7538, 3.0588], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(currentMap);

      // ÿ™ÿÆÿµŸäÿµ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
      if (currentRole === 'rakib') {
        document.getElementById('passengerContent').style.display = 'block';
        document.getElementById('driverContent').style.display = 'none';
        document.getElementById('sidebarTitle').textContent = 'üßç‚Äç‚ôÄÔ∏è ÿ∑ŸÑÿ® ÿ±ÿ≠ŸÑÿ©';
        document.getElementById('activateBtn').textContent = 'üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≥ÿßÿ¶ŸÇ';
      } else {
        document.getElementById('passengerContent').style.display = 'none';
        document.getElementById('driverContent').style.display = 'block';
        document.getElementById('sidebarTitle').textContent = 'üöó ŸÑŸàÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ';
        document.getElementById('activateBtn').textContent = 'üöó ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿÆÿØŸÖÿ©';
      }

      // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ≠ÿßŸÑŸä
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          currentLocation = { lat, lng };
          
          currentMap.setView([lat, lng], 14);
          
          // ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑŸÖŸàŸÇÿπ
          const icon = currentRole === 'rakib' ? 'üßç‚Äç‚ôÄÔ∏è' : 'üöó';
          const marker = L.marker([lat, lng], {
            icon: L.divIcon({
              html: icon,
              iconSize: [30, 30],
              className: 'custom-div-icon'
            })
          }).addTo(currentMap)
            .bindPopup(`üìç ${userName}`)
            .openPopup();
            
          currentMarker = marker;
          
          // ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ
          startLocationTracking();
          
          // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          updateLocationInDB(lat, lng);
          
        }, (error) => {
          console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ:", error);
          alert("‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿÆÿØŸÖÿ© ÿßŸÑŸÖŸàŸÇÿπ.");
        });
      } else {
        alert("‚ö†Ô∏è ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.");
      }
    }
    window.loadMap = loadMap;

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    function updateLocationInDB(lat, lng) {
      if (!currentUser) return;
      
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      const status = currentRole === 'sayeq' ? 
        (document.getElementById('driverStatus')?.value || 'available') : 'active';
      
      set(locationRef, {
        lat: lat,
        lng: lng,
        role: currentRole,
        name: currentUser.displayName,
        timestamp: Date.now(),
        status: status
      });
    }

    // ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±
    function startLocationTracking() {
      if (!currentUser) return;
      
      if (locationInterval) {
        clearInterval(locationInterval);
      }
      
      locationInterval = setInterval(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            currentLocation = { lat, lng };
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            updateLocationInDB(lat, lng);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
            if (currentMarker) {
              currentMarker.setLatLng([lat, lng]);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇŸäŸÜ ÿ£Ÿà ÿßŸÑÿ±ŸÉÿßÿ®
            if (currentRole === 'rakib') {
              updateNearbyDrivers();
            }
          });
        }
      }, 10000); // ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑ 10 ÿ´ŸàÿßŸÜŸä
    }

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿßÿ¶ŸÇŸäŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ŸäŸÜ
    function updateNearbyDrivers() {
      if (!currentLocation || currentRole !== 'rakib') return;
      
      const locationsRef = ref(db, 'locations');
      onValue(locationsRef, (snapshot) => {
        const locations = snapshot.val();
        const driversList = document.getElementById('driversList');
        
        if (!driversList || !locations) return;
        
        const nearbyDrivers = [];
        Object.keys(locations).forEach(userId => {
          const location = locations[userId];
          if (location.role === 'sayeq' && location.status === 'available' && userId !== currentUser.uid) {
            const distance = calculateDistance(currentLocation, location);
            if (distance <= 10) { // ŸÜÿ∑ÿßŸÇ 10 ŸÉŸÖ
              nearbyDrivers.push({ userId, location, distance });
            }
          }
        });
        
        // ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ÿßŸÅÿ©
        nearbyDrivers.sort((a, b) => a.distance - b.distance);
        
        driversList.innerHTML = '';
        if (nearbyDrivers.length === 0) {
          driversList.innerHTML = '<p style="text-align: center; color: #718096;">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿßÿ¶ŸÇŸàŸÜ ŸÖÿ™ÿßÿ≠ŸàŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</p>';
          return;
        }
        
        nearbyDrivers.forEach(({ userId, location, distance }) => {
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          driverCard.innerHTML = `
            <div class="driver-info">
              <div class="driver-name">üöó ${location.name}</div>
              <div class="driver-distance">${distance.toFixed(1)} ŸÉŸÖ</div>
            </div>
            <div class="car-info">
              <div>üì± ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ™ŸàÿßÿµŸÑ</div>
            </div>
            <div class="driver-actions">
              <button class="action-btn chat-btn" onclick="selectDriver('${userId}', '${location.name}', ${distance})">ÿßÿÆÿ™Ÿäÿßÿ±</button>
            </div>
          `;
          driversList.appendChild(driverCard);
        });
      });
    }

    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ŸÜŸÇÿ∑ÿ™ŸäŸÜ
    function calculateDistance(pos1, pos2) {
      const R = 6371;
      const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
      const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≥ÿßÿ¶ŸÇ
    window.selectDriver = (driverId, driverName, distance) => {
      if (!currentUser || !currentLocation) return;
      
      const destination = document.getElementById('destination').value.trim();
      const passengers = document.getElementById('passengers').value;
      const notes = document.getElementById('notes').value.trim();
      
      if (!destination) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ¨Ÿáÿ© ÿ£ŸàŸÑÿßŸã');
        return;
      }
      
      if (!passengers || passengers < 1 || passengers > 8) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑÿ±ŸÉÿßÿ® (1-8)');
        return;
      }
      
      // ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿ±ÿ≠ŸÑÿ©
      const tripRequest = {
        passengerId: currentUser.uid,
        passengerName: currentUser.displayName,
        driverId: driverId,
        driverName: driverName,
        destination: destination,
        passengers: parseInt(passengers),
        notes: notes,
        distance: distance.toFixed(1),
        status: 'pending',
        timestamp: Date.now(),
        passengerLocation: currentLocation
      };
      
      const tripRef = push(ref(db, 'tripRequests'));
      set(tripRef, tripRequest).then(() => {
        alert(`ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿ±ÿ≠ŸÑÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿßÿ¶ŸÇ ${driverName}`);
        
        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
        onValue(tripRef, (snapshot) => {
          const trip = snapshot.val();
          if (trip && trip.status === 'accepted') {
            alert(`üéâ ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿ∑ŸÑÿ®ŸÉ ŸÖŸÜ ${driverName}!`);
            currentTrip = { id: tripRef.key, data: trip };
          } else if (trip && trip.status === 'rejected') {
            alert(`ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ${driverName}`);
            currentTrip = null;
          }
        });
      });
    };

    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ
    window.updateDriverStatus = () => {
      if (!currentUser || currentRole !== 'sayeq') return;
      
      const status = document.getElementById('driverStatus').value;
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      
      get(locationRef).then((snapshot) => {
        if (snapshot.exists()) {
          set(locationRef, {
            ...snapshot.val(),
            status: status,
            updatedAt: Date.now()
          });
        }
      });
    };

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
    function validatePhone(phone) {
      const phoneRegex = /^(06|07|05)\d{8}$/;
      return phoneRegex.test(phone);
    }

    // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßŸÉÿ®
    window.submitPassengerInfo = () => {
      const name = document.getElementById("passengerName").value.trim();
      const phone = document.getElementById("passengerPhone").value.trim();
      
      if (!name) {
        document.getElementById("passengerError").textContent = "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      if (!phone || !validatePhone(phone)) {
        document.getElementById("passengerError").textContent = "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿµÿ≠Ÿäÿ≠";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßŸÉÿ®
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        profileComplete: true
      }).then(() => {
        document.getElementById("passengerSuccess").textContent = "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!";
        document.getElementById("passengerSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ
    window.startDriverMap = () => {
      const name = document.getElementById("driverName").value.trim();
      const phone = document.getElementById("driverPhone").value.trim();
      const carType = document.getElementById("carType").value.trim();
      const carColor = document.getElementById("carColor").value.trim();
      const plateNumber = document.getElementById("plateNumber").value.trim();
      
      if (!name || !phone || !carType || !carColor || !plateNumber) {
        document.getElementById("driverError").textContent = "Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      if (!validatePhone(phone)) {
        document.getElementById("driverError").textContent = "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿµÿ≠Ÿäÿ≠";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥ÿßÿ¶ŸÇ
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        carType: carType,
        carColor: carColor,
        plateNumber: plateNumber,
        profileComplete: true
      }).then(() => {
        document.getElementById("driverSuccess").textContent = "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!";
        document.getElementById("driverSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿπŸáÿØ
    window.showDeclaration = () => {
      const name = document.getElementById("driverName").value.trim();
      if (!name) {
        document.getElementById("driverError").textContent = "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿ£ŸàŸÑÿßŸã";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      const declarationBox = document.getElementById("declarationBox");
      declarationBox.style.display = "block";
      declarationBox.innerHTML = `
        <h4>ÿ™ÿπŸáÿØ ÿßŸÑÿ≥ÿßÿ¶ŸÇ</h4>
        <p>ÿ£ŸÜÿß ÿßŸÑŸÖÿ™ÿπŸáÿØ ÿßŸÑÿ≥ŸäÿØ/ÿ© <strong>${name}</strong> ÿ£ŸÇÿ± Ÿàÿ£ÿ™ÿπŸáÿØ ÿ®ŸÖÿß ŸäŸÑŸä:</p>
        <ul style="text-align: right; line-height: 1.8;">
          <li>ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ŸÇŸàÿßŸÜŸäŸÜ ÿßŸÑŸÖÿ±Ÿàÿ± ŸàÿßŸÑÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿπÿßŸÖÿ©</li>
          <li>ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ© ÿπŸÑŸâ ÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿ±ŸÉÿßÿ®</li>
          <li>ÿπÿØŸÖ ÿßŸÑŸÇŸäÿßÿØÿ© ÿ™ÿ≠ÿ™ ÿ™ÿ£ÿ´Ÿäÿ± ÿ£Ÿä ŸÖŸàÿßÿØ ŸÖÿÆÿØÿ±ÿ© ÿ£Ÿà ŸÉÿ≠ŸàŸÑŸäÿ©</li>
          <li>ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿ®ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÖŸÜÿµÿ©</li>
          <li>ÿßŸÑÿ™ÿπÿßŸÖŸÑ ÿ®ÿ£ÿØÿ® Ÿàÿßÿ≠ÿ™ÿ±ÿßŸÖ ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ±ŸÉÿßÿ®</li>
        </ul>
        <p><strong>ÿßŸÑÿ™ŸàŸÇŸäÿπ:</strong> ${name}</p>
        <p><strong>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> ${new Date().toLocaleDateString('ar-DZ')}</p>
      `;
    };

    // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿ©
    window.activateRide = () => {
      if (currentRole === 'rakib') {
        const destination = document.getElementById("destination").value.trim();
        const passengers = document.getElementById("passengers").value;
        
        if (!destination) {
          alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ¨Ÿáÿ©");
          return;
        }
        
        if (!passengers || passengers < 1 || passengers > 8) {
          alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑÿ±ŸÉÿßÿ® (1-8)");
          return;
        }
        
        alert(`üîç ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≥ÿßÿ¶ŸÇŸäŸÜ ŸÖÿ™ÿßÿ≠ŸäŸÜ ŸÅŸä ŸÖŸÜÿ∑ŸÇÿ™ŸÉ...`);
        updateNearbyDrivers();
      } else {
        // ÿ™ŸÅÿπŸäŸÑ ÿÆÿØŸÖÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ
        const availableSeats = document.getElementById("availableSeats").value;
        const driverNotes = document.getElementById("driverNotes").value.trim();
        
        if (!availableSeats || availableSeats < 1 || availableSeats > 8) {
          alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÖŸÇÿßÿπÿØ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© (1-8)");
          return;
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≥ÿßÿ¶ŸÇ
        updateDriverStatus();
        alert(`üöó ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿÆÿØŸÖÿ™ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ£ŸÜÿ™ ÿßŸÑÿ¢ŸÜ ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ±ŸÉÿßÿ®.`);
      }
    };

    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
    window.logout = () => {
      if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü")) {
        // ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ
        if (locationInterval) {
          clearInterval(locationInterval);
          locationInterval = null;
        }
        
        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if (currentUser) {
          const locationRef = ref(db, `locations/${currentUser.uid}`);
          set(locationRef, null);
        }
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        signOut(auth).then(() => {
          currentUser = null;
          currentRole = null;
          if (currentMap) {
            currentMap.remove();
            currentMap = null;
          }
          showPage("loginPage");
        });
      }
    };

    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™
    document.addEventListener('DOMContentLoaded', function() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('change', function() {
          const label = document.querySelector(`label[for="${this.id}"]`);
          if (this.files.length > 0) {
            label.style.borderColor = '#48bb78';
            label.style.backgroundColor = '#f0fff4';
            label.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÑŸÅ: ${this.files[0].name}`;
          }
        });
      });
    });
  </script>
</body>
</html>
