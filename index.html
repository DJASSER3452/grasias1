<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRASIAS - Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      direction: rtl;
    }
    
    .page {
      display: none;
      width: 100%;
      height: 100vh;
    }
    
    .page.active {
      display: flex;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    
    .box {
      background: white;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.2);
      width: 100%;
      text-align: center;
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    h1, h2, h3 { 
      margin-bottom: 25px; 
      color: #4a5568; 
      font-weight: 600;
    }
    
    input, button, textarea, select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .choice { 
      text-align: right; 
      margin: 25px 0; 
    }
    
    .choice label { 
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      font-size: 16px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    
    .choice label:hover {
      background-color: #f7fafc;
    }
    
    .choice input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-bottom: 0;
    }
    
    .file-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }
    
    .file-input-label {
      display: block;
      padding: 15px;
      background: #f8f9fa;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .file-input-label:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .success-message, .error-message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    .success-message {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .error-message {
      background: #fed7d7;
      color: #742a2a;
    }
    
    #mapPage {
      flex-direction: row;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    #map { 
      width: 65%; 
      height: 100vh; 
    }
    
    .sidebar {
      width: 35%;
      background: #fff;
      padding: 30px;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .sidebar label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      text-align: right;
    }
    
    .driver-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .driver-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .driver-card.selected {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .driver-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .driver-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .driver-distance {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .car-info {
      color: #718096;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .driver-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .call-btn {
      background: #48bb78;
      color: white;
    }

    .call-btn:hover {
      background: #38a169;
    }

    .chat-btn {
      background: #4299e1;
      color: white;
    }

    .chat-btn:hover {
      background: #3182ce;
    }

    .select-btn {
      background: #667eea;
      color: white;
    }

    .select-btn:hover {
      background: #5a67d8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-right: 4px solid #667eea;
      z-index: 1000;
      max-width: 350px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .notification-content {
      color: #4a5568;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .notification-actions {
      display: flex;
      gap: 10px;
    }

    .accept-btn, .reject-btn {
      flex: 1;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .accept-btn {
      background: #48bb78;
      color: white;
    }

    .reject-btn {
      background: #e53e3e;
      color: white;
    }

    .chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .chat-header {
      background: #667eea;
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      max-height: 250px;
    }

    .chat-input-container {
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 0;
    }

    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 0;
      width: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.sent {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: left;
    }

    .message.received {
      background: #f7fafc;
      color: #2d3748;
      margin-right: auto;
    }

    .trip-status {
      background: #e6fffa;
      border: 1px solid #81e6d9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .trip-status.active {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    @media (max-width: 768px) {
      #mapPage {
        flex-direction: column;
      }
      
      #map {
        width: 100%;
        height: 60vh;
      }
      
      .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
      }
      
      .box {
        margin: 10px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="box">
        <h1>ğŸš– GRASIAS</h1>
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
        <div class="choice">
          <label>
            <input type="radio" name="role" value="sayeq"> 
            <span>ğŸš— Ø³Ø§Ø¦Ù‚</span>
          </label>
          <label>
            <input type="radio" name="role" value="rakib"> 
            <span>ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨</span>
          </label>
        </div>
        <button onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
  <div id="passengerPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h2>
        <div class="success-message" id="passengerSuccess"></div>
        <div class="error-message" id="passengerError"></div>
        
        <input type="text" id="passengerName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        <input type="tel" id="passengerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="passengerIdCard" accept="image/*" />
          <label for="passengerIdCard" class="file-input-label">
            ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
          </label>
        </div>
        
        <button onclick="submitPassengerInfo()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
  <div id="driverPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
        <div class="success-message" id="driverSuccess"></div>
        <div class="error-message" id="driverError"></div>
        
        <input type="text" id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        <input type="tel" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
        <input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§)" required>
        <input type="text" id="carColor" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
        <input type="text" id="plateNumber" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="driverId" accept="image/*" required>
          <label for="driverId" class="file-input-label">
            ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
          </label>
        </div>
        
        <div class="file-input-wrapper">
          <input type="file" id="carCheck" accept="image/*" required>
          <label for="carCheck" class="file-input-label">
            ğŸ”§ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ
          </label>
        </div>
        
        <button onclick="showDeclaration()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
        <div class="declaration-box" id="declarationBox" style="display: none; text-align: right;"></div>
        <button onclick="startDriverMap()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div id="mapPage" class="page">
    <div id="map"></div>
    <div class="sidebar">
      <h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
      
      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
      <div id="passengerContent" style="display: none;">
        <label>Ø§Ù„ÙˆØ¬Ù‡Ø©:</label>
        <input type="text" id="destination" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØ¬Ù‡ØªÙƒ (Ù…Ø«Ø§Ù„: Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)">
        
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨:</label>
        <input type="number" id="passengers" min="1" max="8" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨" value="1">
        
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
        <textarea id="notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ©..." style="height: 80px; resize: vertical;"></textarea>
        
        <div id="nearbyDrivers">
          <h4>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
          <div id="driversList"></div>
        </div>
      </div>

      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
      <div id="driverContent" style="display: none;">
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
        <select id="driverStatus" onchange="updateDriverStatus()">
          <option value="available">Ù…ØªØ§Ø­</option>
          <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
          <option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
        </select>
        
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
        <input type="number" id="availableSeats" min="1" max="8" value="4">
        
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
        <textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height: 60px;"></textarea>
      </div>
      
      <button onclick="activateRide()" id="activateBtn">ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
      <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
      authDomain: "grasias-d7830.firebaseapp.com",
      databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "grasias-d7830",
      storageBucket: "grasias-d7830.appspot.com",
      messagingSenderId: "134413476604",
      appId: "1:134413476604:web:ab1acfa69c025218cbad79",
      measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let currentUser = null;
    let currentRole = null;
    let currentMap = null;
    let currentMarker = null;
    let currentLocation = null;
    let selectedDriver = null;
    let currentTrip = null;
    let locationInterval = null;

    // Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
    window.db = db;
    window.auth = auth;

    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }
    window.showPage = showPage;

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
    window.signInWithGoogle = () => {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        return;
      }
      
      currentRole = roleInput.value;

      signInWithPopup(auth, provider)
        .then((result) => {
          currentUser = result.user;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const userRef = ref(db, `users/${currentUser.uid}`);
          get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const userData = snapshot.val();
              if (userData.profileComplete) {
                showPage("mapPage");
                loadMap(userData.fullName || currentUser.displayName);
              } else {
                if (userData.role === "rakib") {
                  showPage("passengerPage");
                } else {
                  showPage("driverPage");
                }
              }
            } else {
              // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
              set(userRef, {
                name: currentUser.displayName,
                email: currentUser.email,
                role: currentRole,
                createdAt: new Date().toISOString(),
                profileComplete: false
              });
              
              if (currentRole === "rakib") {
                showPage("passengerPage");
              } else {
                showPage("driverPage");
              }
            }
          });
        })
        .catch((error) => {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
          alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
        });
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function loadMap(userName) {
      if (currentMap) {
        currentMap.remove();
      }
      
      currentMap = L.map('map').setView([36.7538, 3.0588], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(currentMap);

      // ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (currentRole === 'rakib') {
        document.getElementById('passengerContent').style.display = 'block';
        document.getElementById('driverContent').style.display = 'none';
        document.getElementById('sidebarTitle').textContent = 'ğŸ§â€â™€ï¸ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©';
        document.getElementById('activateBtn').textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
      } else {
        document.getElementById('passengerContent').style.display = 'none';
        document.getElementById('driverContent').style.display = 'block';
        document.getElementById('sidebarTitle').textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
        document.getElementById('activateBtn').textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          currentLocation = { lat, lng };
          
          currentMap.setView([lat, lng], 14);
          
          // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
          const icon = currentRole === 'rakib' ? 'ğŸ§â€â™€ï¸' : 'ğŸš—';
          const marker = L.marker([lat, lng], {
            icon: L.divIcon({
              html: icon,
              iconSize: [30, 30],
              className: 'custom-div-icon'
            })
          }).addTo(currentMap)
            .bindPopup(`ğŸ“ ${userName}`)
            .openPopup();
            
          currentMarker = marker;
          
          // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          startLocationTracking();
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          updateLocationInDB(lat, lng);
          
        }, (error) => {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
          alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        });
      } else {
        alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
      }
    }
    window.loadMap = loadMap;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function updateLocationInDB(lat, lng) {
      if (!currentUser) return;
      
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      const status = currentRole === 'sayeq' ? 
        (document.getElementById('driverStatus')?.value || 'available') : 'active';
      
      set(locationRef, {
        lat: lat,
        lng: lng,
        role: currentRole,
        name: currentUser.displayName,
        timestamp: Date.now(),
        status: status
      });
    }

    // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    function startLocationTracking() {
      if (!currentUser) return;
      
      if (locationInterval) {
        clearInterval(locationInterval);
      }
      
      locationInterval = setInterval(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            currentLocation = { lat, lng };
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            updateLocationInDB(lat, lng);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (currentMarker) {
              currentMarker.setLatLng([lat, lng]);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø±ÙƒØ§Ø¨
            if (currentRole === 'rakib') {
              updateNearbyDrivers();
            }
          });
        }
      }, 10000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†
    function updateNearbyDrivers() {
      if (!currentLocation || currentRole !== 'rakib') return;
      
      const locationsRef = ref(db, 'locations');
      onValue(locationsRef, (snapshot) => {
        const locations = snapshot.val();
        const driversList = document.getElementById('driversList');
        
        if (!driversList || !locations) return;
        
        const nearbyDrivers = [];
        Object.keys(locations).forEach(userId => {
          const location = locations[userId];
          if (location.role === 'sayeq' && location.status === 'available' && userId !== currentUser.uid) {
            const distance = calculateDistance(currentLocation, location);
            if (distance <= 10) { // Ù†Ø·Ø§Ù‚ 10 ÙƒÙ…
              nearbyDrivers.push({ userId, location, distance });
            }
          }
        });
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        nearbyDrivers.sort((a, b) => a.distance - b.distance);
        
        driversList.innerHTML = '';
        if (nearbyDrivers.length === 0) {
          driversList.innerHTML = '<p style="text-align: center; color: #718096;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
          return;
        }
        
        nearbyDrivers.forEach(({ userId, location, distance }) => {
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          driverCard.innerHTML = `
            <div class="driver-info">
              <div class="driver-name">ğŸš— ${location.name}</div>
              <div class="driver-distance">${distance.toFixed(1)} ÙƒÙ…</div>
            </div>
            <div class="car-info">
              <div>ğŸ“± Ù…ØªØ§Ø­ Ù„Ù„ØªÙˆØ§ØµÙ„</div>
            </div>
            <div class="driver-actions">
              <button class="action-btn chat-btn" onclick="selectDriver('${userId}', '${location.name}', ${distance})">Ø§Ø®ØªÙŠØ§Ø±</button>
            </div>
          `;
          driversList.appendChild(driverCard);
        });
      });
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    function calculateDistance(pos1, pos2) {
      const R = 6371;
      const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
      const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚
    window.selectDriver = (driverId, driverName, distance) => {
      if (!currentUser || !currentLocation) return;
      
      const destination = document.getElementById('destination').value.trim();
      const passengers = document.getElementById('passengers').value;
      const notes = document.getElementById('notes').value.trim();
      
      if (!destination) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      if (!passengers || passengers < 1 || passengers > 8) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ø±ÙƒØ§Ø¨ (1-8)');
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©
      const tripRequest = {
        passengerId: currentUser.uid,
        passengerName: currentUser.displayName,
        driverId: driverId,
        driverName: driverName,
        destination: destination,
        passengers: parseInt(passengers),
        notes: notes,
        distance: distance.toFixed(1),
        status: 'pending',
        timestamp: Date.now(),
        passengerLocation: currentLocation
      };
      
      const tripRef = push(ref(db, 'tripRequests'));
      set(tripRef, tripRequest).then(() => {
        alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName}`);
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        onValue(tripRef, (snapshot) => {
          const trip = snapshot.val();
          if (trip && trip.status === 'accepted') {
            alert(`ğŸ‰ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ù…Ù† ${driverName}!`);
            currentTrip = { id: tripRef.key, data: trip };
          } else if (trip && trip.status === 'rejected') {
            alert(`ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† ${driverName}`);
            currentTrip = null;
          }
        });
      });
    };

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    window.updateDriverStatus = () => {
      if (!currentUser || currentRole !== 'sayeq') return;
      
      const status = document.getElementById('driverStatus').value;
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      
      get(locationRef).then((snapshot) => {
        if (snapshot.exists()) {
          set(locationRef, {
            ...snapshot.val(),
            status: status,
            updatedAt: Date.now()
          });
        }
      });
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    function validatePhone(phone) {
      const phoneRegex = /^(06|07|05)\d{8}$/;
      return phoneRegex.test(phone);
    }

    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
    window.submitPassengerInfo = () => {
      const name = document.getElementById("passengerName").value.trim();
      const phone = document.getElementById("passengerPhone").value.trim();
      
      if (!name) {
        document.getElementById("passengerError").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      if (!phone || !validatePhone(phone)) {
        document.getElementById("passengerError").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        profileComplete: true
      }).then(() => {
        document.getElementById("passengerSuccess").textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
        document.getElementById("passengerSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
    window.startDriverMap = () => {
      const name = document.getElementById("driverName").value.trim();
      const phone = document.getElementById("driverPhone").value.trim();
      const carType = document.getElementById("carType").value.trim();
      const carColor = document.getElementById("carColor").value.trim();
      const plateNumber = document.getElementById("plateNumber").value.trim();
      
      if (!name || !phone || !carType || !carColor || !plateNumber) {
        document.getElementById("driverError").textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      if (!validatePhone(phone)) {
        document.getElementById("driverError").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        carType: carType,
        carColor: carColor,
        plateNumber: plateNumber,
        profileComplete: true
      }).then(() => {
        document.getElementById("driverSuccess").textContent = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
        document.getElementById("driverSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯
    window.showDeclaration = () => {
      const name = document.getElementById("driverName").value.trim();
      if (!name) {
        document.getElementById("driverError").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      const declarationBox = document.getElementById("declarationBox");
      declarationBox.style.display = "block";
      declarationBox.innerHTML = `
        <h4>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
        <p>Ø£Ù†Ø§ Ø§Ù„Ù…ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³ÙŠØ¯/Ø© <strong>${name}</strong> Ø£Ù‚Ø± ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:</p>
        <ul style="text-align: right; line-height: 1.8;">
          <li>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</li>
          <li>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø±ÙƒØ§Ø¨</li>
          <li>Ø¹Ø¯Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ØªØ­Øª ØªØ£Ø«ÙŠØ± Ø£ÙŠ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±Ø© Ø£Ùˆ ÙƒØ­ÙˆÙ„ÙŠØ©</li>
          <li>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ù†ØµØ©</li>
          <li>Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø¨Ø£Ø¯Ø¨ ÙˆØ§Ø­ØªØ±Ø§Ù… Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙƒØ§Ø¨</li>
        </ul>
        <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</strong> ${name}</p>
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-DZ')}</p>
      `;
    };

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    window.activateRide = () => {
      if (currentRole === 'rakib') {
        const destination = document.getElementById("destination").value.trim();
        const passengers = document.getElementById("passengers").value;
        
        if (!destination) {
          alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©");
          return;
        }
        
        if (!passengers || passengers < 1 || passengers > 8) {
          alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ø±ÙƒØ§Ø¨ (1-8)");
          return;
        }
        
        alert(`ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ...`);
        updateNearbyDrivers();
      } else {
        // ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
        const availableSeats = document.getElementById("availableSeats").value;
        const driverNotes = document.getElementById("driverNotes").value.trim();
        
        if (!availableSeats || availableSeats < 1 || availableSeats > 8) {
          alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© (1-8)");
          return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
        updateDriverStatus();
        alert(`ğŸš— ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø­ Ù„Ù„Ø±ÙƒØ§Ø¨.`);
      }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logout = () => {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        if (locationInterval) {
          clearInterval(locationInterval);
          locationInterval = null;
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (currentUser) {
          const locationRef = ref(db, `locations/${currentUser.uid}`);
          set(locationRef, null);
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        signOut(auth).then(() => {
          currentUser = null;
          currentRole = null;
          if (currentMap) {
            currentMap.remove();
            currentMap = null;
          }
          showPage("loginPage");
        });
      }
    };

    // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    document.addEventListener('DOMContentLoaded', function() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('change', function() {
          const label = document.querySelector(`label[for="${this.id}"]`);
          if (this.files.length > 0) {
            label.style.borderColor = '#48bb78';
            label.style.backgroundColor = '#f0fff4';
            label.innerHTML = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${this.files[0].name}`;
          }
        });
      });
    });
  </script>
</body>
</html>
