<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GRASIAS - ÙƒØ§Ù…Ù„</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
  direction: rtl; padding:20px;
}
.box { background:white; padding:30px 25px; border-radius:20px; box-shadow:0 15px 50px rgba(0,0,0,0.2); width:100%; max-width:400px; text-align:center; animation:fadeIn .6s ease-in-out; }
@keyframes fadeIn { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
h2{ margin-bottom:25px; color:#4a5568; font-weight:600; font-size:24px; }
input, button, textarea, select { width:100%; padding:15px; border-radius:12px; margin-bottom:15px; font-size:16px; border:2px solid #e2e8f0; transition:all .3s; }
input:focus, textarea:focus, select:focus { border-color:#667eea; outline:none; box-shadow:0 0 0 3px rgba(102,126,234,.1); }
button { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; cursor:pointer; font-weight:600; transition:transform .2s; }
button:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,.3); }
.choice{ text-align:right; margin:25px 0; }
.choice label{ display:flex; align-items:center; margin-bottom:12px; font-size:16px; cursor:pointer; padding:10px; border-radius:8px; }
.declaration-box { margin-top:20px; background:#f8f9fa; padding:20px; border-radius:12px; text-align:right; display:none; border-right:4px solid #667eea; line-height:1.6; }

#mapPage { display:none; height:100vh; width:100vw; flex-direction:row; position:fixed; top:0; left:0; right:0; bottom:0; }
#map { width:65%; height:100vh; }
.sidebar { width:35%; background:#fff; padding:30px; overflow-y:auto; box-shadow:-2px 0 10px rgba(0,0,0,.1); }
.sidebar h3{ color:#4a5568; margin-bottom:20px; font-size:20px; text-align:right; }

#passengerPage,#driverPage,#mapPage{ display:none; }

.file-input-wrapper { position:relative; margin-bottom:15px; }
.file-input-wrapper input[type="file"] { opacity:0; position:absolute; z-index:-1; }
.file-input-label { display:block; padding:15px; background:#f8f9fa; border:2px dashed #cbd5e0; border-radius:12px; text-align:center; cursor:pointer; transition:all .3s; }
.file-input-label:hover { border-color:#667eea; background:#edf2f7; }

.success-message { background:#c6f6d5; color:#22543d; padding:12px; border-radius:8px; margin-bottom:15px; display:none; }
.error-message { background:#fed7d7; color:#742a2a; padding:12px; border-radius:8px; margin-bottom:15px; display:none; }

.driver-card { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,.1); border:2px solid transparent; cursor:pointer; transition:all .3s; }
.driver-card:hover { border-color:#667eea; transform:translateY(-2px); }
.driver-card.selected { border-color:#48bb78; background:#f0fff4; }
.driver-info { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.driver-name { font-weight:600; color:#2d3748; font-size:16px; }
.driver-distance { background:#667eea; color:white; padding:4px 8px; border-radius:6px; font-size:12px; }

.driver-actions { display:flex; gap:10px; }
.action-btn { flex:1; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; }
.call-btn { background:#48bb78; color:white; }
.chat-btn { background:#4299e1; color:white; }
.select-btn { background:#667eea; color:white; }

.notification { position:fixed; top:20px; right:20px; background:white; padding:20px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.15); border-right:4px solid #667eea; z-index:1000; max-width:350px; animation:slideIn .3s ease-out; }
@keyframes slideIn { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
.notification-title{ font-weight:600; color:#2d3748; margin-bottom:10px; }
.notification-content{ color:#4a5568; margin-bottom:15px; line-height:1.5; }
.notification-actions { display:flex; gap:10px; }
.accept-btn { background:#48bb78; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; }
.reject-btn { background:#e53e3e; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; }

.chat-container { position:fixed; bottom:20px; right:20px; width:320px; height:420px; background:white; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.15); display:none; flex-direction:column; z-index:1000; }
.chat-header { background:#667eea; color:white; padding:15px; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center; }
.chat-messages { flex:1; padding:15px; overflow-y:auto; max-height:250px; }
.chat-input-container { padding:15px; border-top:1px solid #e2e8f0; display:flex; gap:10px; }
.chat-input { flex:1; padding:8px 12px; border:1px solid #e2e8f0; border-radius:8px; margin:0; }
.send-btn { background:#667eea; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; margin:0; width:auto; }

.message { margin-bottom:10px; padding:8px 12px; border-radius:8px; max-width:80%; }
.message.sent { background:#667eea; color:white; margin-left:auto; text-align:left; }
.message.received { background:#f7fafc; color:#2d3748; margin-right:auto; }

.trip-status { background:#e6fffa; border:1px solid #81e6d9; border-radius:8px; padding:15px; margin-bottom:15px; text-align:center; }
.trip-status.active { background:#f0fff4; border-color:#9ae6b4; }

.distance-calculator { background:#f8f9fa; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-bottom:15px; }
.distance-input { display:flex; gap:10px; margin-bottom:10px; }
.distance-input input { flex:1; margin:0; }
.price-display { background:#667eea; color:white; padding:10px; border-radius:8px; text-align:center; font-weight:600; font-size:18px; }

.driver-popup { background:white; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); min-width:200px; }
.driver-popup h4 { margin:0 0 10px 0; color:#2d3748; font-size:16px; }
.driver-popup p { margin:5px 0; color:#4a5568; font-size:14px; }

@media (max-width:768px) {
  #mapPage { flex-direction:column; }
  #map { width:100%; height:60vh; }
  .sidebar { width:100%; height:40vh; padding:20px; }
  .chat-container { width:90%; right:5%; left:5%; }
  .notification { right:10px; left:10px; max-width:none; }
}
</style>
</head>
<body>
<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginPage">
  <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ GRASIAS</h2>
  <div class="choice">
    <label><input type="radio" name="role" value="sayeq"> <span>ğŸš— Ø³Ø§Ø¦Ù‚</span></label>
    <label><input type="radio" name="role" value="rakib"> <span>ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨</span></label>
  </div>
  <button onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div class="box" id="passengerPage">
  <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h2>
  <div class="success-message" id="passengerSuccess"></div>
  <div class="error-message" id="passengerError"></div>
  <input type="text" id="passengerName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
  <input type="tel" id="passengerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
  <div class="file-input-wrapper">
    <input type="file" id="passengerIdCard" accept="image/*" />
    <label for="passengerIdCard" class="file-input-label">ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</label>
  </div>
  <button onclick="submitPassengerInfo()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div class="box" id="driverPage">
  <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
  <div class="success-message" id="driverSuccess"></div>
  <div class="error-message" id="driverError"></div>
  <input type="text" id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
  <input type="tel" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
  <input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§)" required>
  <input type="text" id="carColor" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
  <input type="text" id="plateNumber" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
  <div class="file-input-wrapper">
    <input type="file" id="driverId" accept="image/*" required>
    <label for="driverId" class="file-input-label">ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</label>
  </div>
  <div class="file-input-wrapper">
    <input type="file" id="carCheck" accept="image/*" required>
    <label for="carCheck" class="file-input-label">ğŸ”§ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ</label>
  </div>
  <button onclick="showDeclaration()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
  <div class="declaration-box" id="declarationBox"></div>
  <button onclick="startDriverMap()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapPage">
  <div id="map"></div>
  <div class="sidebar">
    <div id="tripStatus" class="trip-status" style="display:none;">
      <div id="tripStatusText"></div>
    </div>
    <h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
    <div id="passengerContent">
      <div id="nearbyDrivers">
        <h4 style="text-align:right">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
        <div id="driversList"></div>
      </div>
      <div style="margin-top:10px;">
        <button onclick="cancelMyRequest()" style="background:#e53e3e">ğŸš« Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ÙŠ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)</button>
      </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driverContent" style="display:none;">
      <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
      <select id="driverStatus" onchange="updateDriverStatus()">
        <option value="available">Ù…ØªØ§Ø­</option>
        <option value="busy">Ù…Ø´ØºÙˆÙ„</option>
        <option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
      </select>

      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
      <input type="number" id="availableSeats" min="1" max="8" value="4">

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
      <textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height:60px;"></textarea>

      <!-- Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø«Ù…Ù† -->
      <div class="distance-calculator">
        <h4>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø«Ù…Ù†:</h4>
        <div class="distance-input">
          <input type="number" id="distanceInput" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)" min="1" onchange="calculatePrice()">
        </div>
        <div id="priceDisplay" class="price-display" style="display:none;">
          Ø§Ù„Ø«Ù…Ù†: <span id="calculatedPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button onclick="activateRide()" id="activateBtn">ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
      <button onclick="logout()" style="background:#e53e3e; margin-top:10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
    <hr style="margin:15px 0;">
    <div style="text-align:right">
      <label style="font-weight:700">Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©:</label>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button onclick="setBaseLayer('osm')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">ğŸ—ºï¸ Ø·Ø±Ù‚</button>
        <button onclick="setBaseLayer('sat')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">ğŸ›°ï¸ ØµÙˆØ±</button>
        <button onclick="setBaseLayer('toner')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">ğŸ–¤ Ù‚Ù„Ù…</button>
      </div>
    </div>

  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chatContainer" class="chat-container">
  <div class="chat-header">
    <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
    <button onclick="closeChat()" style="background:none;border:none;color:white;cursor:pointer;padding:0;margin:0;width:auto;">âœ•</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button onclick="sendMessage()" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Firebase (module) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
  authDomain: "grasias-d7830.firebaseapp.com",
  databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "grasias-d7830",
  storageBucket: "grasias-d7830.appspot.com",
  messagingSenderId: "134413476604",
  appId: "1:134413476604:web:ab1acfa69c025218cbad79",
  measurementId: "G-6QBYM41CJ1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.currentUser = null;
window.currentRole = null;
window.db = db;
window.auth = auth;
window.ref = ref;
window.set = set;
window.get = get;
window.update = update;
window.push = push;
window.onValue = onValue;

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.signInWithGoogle = () => {
  const roleInput = document.querySelector('input[name="role"]:checked');
  if (!roleInput) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }
  window.currentRole = roleInput.value;

  signInWithPopup(auth, provider)
    .then((result) => {
      const user = result.user;
      window.currentUser = user;
      const userRef = ref(db, `users/${user.uid}`);
      get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          if (userData.role) window.currentRole = userData.role;
          showPage("mapPage");
          loadMap(user.displayName);
          startLocationTracking();
        } else {
          set(userRef, { name: user.displayName, email: user.email, role: window.currentRole, createdAt: new Date().toISOString() })
            .then(() => {
              if (window.currentRole === "rakib") showPage("passengerPage"); else showPage("driverPage");
            });
        }
      });
    })
    .catch((error) => { console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error); alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message); });
};
</script>

<!-- Leaflet & Routing scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© ===== */
let currentMap = null;
let currentMarker = null;
let driversMarkers = [];
let passengersMarkers = [];
let currentLocation = null;
let selectedDriver = null;
let currentTrip = null;
let routeControl = null;
let currentChatPartner = null;
let baseLayers = {};
let activeBaseLayerKey = 'osm';
let myRequestKey = null; // Ù…ÙØªØ§Ø­ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
const driverIcon = L.divIcon({ html: 'ğŸš—', iconSize: [30,30], className: 'custom-div-icon' });
const passengerIcon = L.divIcon({ html: 'ğŸ§â€â™€ï¸', iconSize: [30,30], className: 'custom-div-icon' });

/* Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª */
function showPage(id) {
  ["loginPage","passengerPage","driverPage","mapPage"].forEach(p => document.getElementById(p).style.display = "none");
  document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
}

/* Ø±Ø³Ø§Ø¦Ù„ Ù†Ø¬Ø§Ø­/Ø®Ø·Ø£ */
function showMessage(type, message, pagePrefix='') {
  const successEl = document.getElementById(pagePrefix + 'Success');
  const errorEl = document.getElementById(pagePrefix + 'Error');
  if (type === 'success') {
    if (successEl) { successEl.textContent = message; successEl.style.display='block'; }
    if (errorEl) errorEl.style.display='none';
  } else {
    if (errorEl) { errorEl.textContent = message; errorEl.style.display='block'; }
    if (successEl) successEl.style.display='none';
  }
  setTimeout(()=>{ if (successEl) successEl.style.display='none'; if (errorEl) errorEl.style.display='none'; },5000);
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù…Ù† (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
function calculatePrice() {
  const distance = parseFloat(document.getElementById('distanceInput').value);
  if (!distance || distance <= 0) { document.getElementById('priceDisplay').style.display='none'; return; }
  let totalPrice = 0;
  if (distance <= 20) totalPrice = distance * 10;
  else if (distance <= 50) totalPrice = (20*10) + ((distance-20)*5);
  else totalPrice = (20*10) + (30*5) + ((distance-50)*2);
  document.getElementById('calculatedPrice').textContent = totalPrice;
  document.getElementById('priceDisplay').style.display = 'block';
}

/* ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª ===== */
function loadMap(userName) {
  if (currentMap) currentMap.remove();

  currentMap = L.map('map').setView([28.0339,1.6596],6);

  // Base layers
  baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(currentMap);
  baseLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
  baseLayers.toner = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', { attribution: 'Stamen' });

  L.control.scale({ position: 'bottomleft' }).addTo(currentMap);

  // Layer control (Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹)
  L.control.layers({
    "Ø®Ø±Ø§Ø¦Ø· (OSM)": baseLayers.osm,
    "ØµÙˆØ± ÙØ¶Ø§Ø¦ÙŠØ©": baseLayers.sat,
    "Ù‚Ù„Ù… (Toner)": baseLayers.toner
  }, {}, { position: 'bottomright' }).addTo(currentMap);

  // ØªØ£Ù‚Ù„Ù… ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
  if (window.currentRole === 'rakib') {
    document.getElementById('passengerContent').style.display = 'block';
    document.getElementById('driverContent').style.display = 'none';
    document.getElementById('sidebarTitle').textContent = 'ğŸ§â€â™€ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
    document.getElementById('activateBtn').textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
  } else {
    document.getElementById('passengerContent').style.display = 'none';
    document.getElementById('driverContent').style.display = 'block';
    document.getElementById('sidebarTitle').textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
    document.getElementById('activateBtn').textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude, lng = position.coords.longitude;
      currentLocation = { lat, lng };
      currentMap.setView([lat,lng],14);

      if (currentMarker) currentMap.removeLayer(currentMarker);
      const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
      currentMarker = L.marker([lat,lng], { icon }).addTo(currentMap).bindPopup(`ğŸ“ ${userName}`).openPopup();

      startLocationTracking(); // ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹
    }, (err)=>{ console.error("Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹:",err); alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS"); });
  } else { alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹."); }
}

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
function setBaseLayer(key) {
  if (!baseLayers[key]) return;
  if (activeBaseLayerKey && baseLayers[activeBaseLayerKey]) currentMap.removeLayer(baseLayers[activeBaseLayerKey]);
  baseLayers[key].addTo(currentMap);
  activeBaseLayerKey = key;
}

/* ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Firebase ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ */
function startLocationTracking() {
  if (!window.currentUser) return;

  // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø£ÙˆÙ„Ù‹Ø§
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos=>{
      const newLocation = buildLocationObject(pos.coords);
      window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);
      currentLocation = { lat:newLocation.lat, lng:newLocation.lng };
      if (currentMarker) currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
    });
  }

  setInterval(()=> {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const newLocation = buildLocationObject(position.coords);
        window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);
        currentLocation = { lat:newLocation.lat, lng:newLocation.lng };
        if (currentMarker) currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
      });
    }
  }, 10000);

  if (window.currentRole === 'rakib') watchDrivers(); else watchPassengers();
  watchTripRequests();
}

function buildLocationObject(coords) {
  const obj = { lat: coords.latitude, lng: coords.longitude, role: window.currentRole, name: window.currentUser.displayName, timestamp: Date.now(), status: window.currentRole === 'sayeq' ? (document.getElementById('driverStatus')?.value || 'available') : 'active' };
  if (window.currentRole === 'sayeq') {
    const driverData = JSON.parse(localStorage.getItem('driverData')||'{}');
    obj.phone = driverData.phone || '';
    obj.carType = driverData.carType || '';
    obj.carColor = driverData.carColor || '';
    obj.plateNumber = driverData.plateNumber || '';
    obj.availableSeats = parseInt(document.getElementById('availableSeats')?.value || 4);
    obj.notes = document.getElementById('driverNotes')?.value || '';
  }
  return obj;
}

/* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù„Ù„Ø±Ø§ÙƒØ¨ */
function watchDrivers() {
  const driversRef = window.ref(window.db, 'locations');
  window.onValue(driversRef, snapshot => {
    const locations = snapshot.val();
    updateDriversOnMap(locations);
    updateDriversList(locations);
  });
}

/* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙƒØ§Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ */
function watchPassengers() {
  const passengersRef = window.ref(window.db, 'locations');
  window.onValue(passengersRef, snapshot => {
    const locations = snapshot.val();
    updatePassengersOnMap(locations);
  });
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
function updateDriversOnMap(locations) {
  driversMarkers.forEach(m => currentMap.removeLayer(m));
  driversMarkers = [];
  if (!locations) return;
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
      const marker = L.marker([location.lat, location.lng], { icon: driverIcon }).addTo(currentMap);
      const popupContent = `
        <div class="driver-popup">
          <h4>ğŸš— ${location.name}</h4>
          <p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${location.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
          <p><strong>ğŸš™ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
          <p><strong>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
          <p><strong>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${location.plateNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
          <p><strong>ğŸ’º Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</strong> ${location.availableSeats || 4}</p>
          ${location.notes ? `<p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${location.notes}</p>` : ''}
        </div>`;
      marker.bindPopup(popupContent);
      marker.userId = userId;
      driversMarkers.push(marker);
    }
  });
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
function updatePassengersOnMap(locations) {
  passengersMarkers.forEach(m => currentMap.removeLayer(m));
  passengersMarkers = [];
  if (!locations) return;
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'rakib' && userId !== window.currentUser?.uid) {
      const marker = L.marker([location.lat, location.lng], { icon: passengerIcon }).addTo(currentMap);
      const popupContent = `<div class="driver-popup"><h4>ğŸ§â€â™€ï¸ ${location.name}</h4><p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> Ø±Ø§ÙƒØ¨ ÙŠØ¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©</p></div>`;
      marker.bindPopup(popupContent);
      marker.userId = userId;
      passengersMarkers.push(marker);
    }
  });
}

/* ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©) */
function updateDriversList(locations) {
  const driversList = document.getElementById('driversList');
  if (!driversList) return;
  driversList.innerHTML = '';
  if (!locations || !currentLocation) return;
  const availableDrivers = [];
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
      const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
      availableDrivers.push({ ...location, userId, distance });
    }
  });
  availableDrivers.sort((a,b)=>a.distance-b.distance);
  availableDrivers.forEach(driver => {
    const driverCard = document.createElement('div');
    driverCard.className = 'driver-card';
    driverCard.innerHTML = `
      <div class="driver-info">
        <span class="driver-name">ğŸš— ${driver.name}</span>
        <span class="driver-distance">${driver.distance.toFixed(1)} ÙƒÙ…</span>
      </div>
      <div class="car-info">ğŸš™ ${driver.carType||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ğŸ¨ ${driver.carColor||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>ğŸ’º ${driver.availableSeats||4} Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©</div>
      <div class="driver-actions">
        <button class="action-btn call-btn" onclick="callDriver('${driver.phone}')">ğŸ“ Ø§ØªØµØ§Ù„</button>
        <button class="action-btn chat-btn" onclick="startChat('${driver.userId}','${escapeHtml(driver.name)}')">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
        <button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">âœ… Ø§Ø®ØªÙŠØ§Ø±</button>
      </div>`;
    driversList.appendChild(driverCard);
  });
  if (availableDrivers.length === 0) {
    driversList.innerHTML = '<p style="text-align:center;color:#718096">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
  }
}

/* Ù‡Ø§ÙØ±Ø³Ø§Ù„ Ø±Ù‚Ù…ÙŠ Ø¨Ø³ÙŠØ· Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine) */
function calculateDistance(lat1,lng1,lat2,lng2) {
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function callDriver(phone) {
  if (phone && phone !== 'ØºÙŠØ± Ù…ØªÙˆÙØ±') window.open(`tel:${phone}`,'_self'); else alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±');
}

/* ===== Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ===== */
function startChat(userId, userName) {
  currentChatPartner = { userId, userName };
  document.getElementById('chatTitle').textContent = `Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${userName}`;
  document.getElementById('chatContainer').style.display = 'flex';
  loadChatMessages(userId);
}

function closeChat() { document.getElementById('chatContainer').style.display='none'; currentChatPartner = null; }

function loadChatMessages(partnerId) {
  if (!window.currentUser) return;
  const chatId = [window.currentUser.uid, partnerId].sort().join('_');
  const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);
  window.onValue(messagesRef, (snapshot) => {
    const messages = snapshot.val();
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    if (messages) {
      Object.keys(messages).forEach(messageId => {
        const message = messages[messageId];
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent':'received'}`;
        messageDiv.textContent = `${message.text}`;
        chatMessages.appendChild(messageDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
}

function sendMessage() {
  const chatInput = document.getElementById('chatInput');
  const messageText = chatInput.value.trim();
  if (!messageText || !currentChatPartner) return;
  const chatId = [window.currentUser.uid, currentChatPartner.userId].sort().join('_');
  const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);
  window.push(messagesRef, { text: messageText, senderId: window.currentUser.uid, senderName: window.currentUser.displayName, timestamp: Date.now() });
  chatInput.value='';
}

/* ===== Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚ (Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©) ===== */
function selectDriver(driverId) {
  selectedDriver = driverId;
  if (!window.currentUser || !currentLocation) { alert("Ù…ÙˆÙ‚Ø¹Ùƒ ØºÙŠØ± Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯"); return; }
  const tripRequest = {
    passengerId: window.currentUser.uid,
    passengerName: window.currentUser.displayName,
    passengerLocation: currentLocation,
    driverId: driverId,
    status: 'pending',
    timestamp: Date.now()
  };
  // Ø§Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ (key) Ù„ÙƒÙŠ Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ø§Ø­Ù‚Ù‹Ø§
  const newRef = window.push(window.ref(window.db, 'tripRequests'), tripRequest);
  myRequestKey = newRef.key;
  // Ø®Ø²Ù‘Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø£ÙŠØ¶Ù‹Ø§
  localStorage.setItem('myRequestKey', myRequestKey);
  showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©','ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...','info');
}

/* Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø§ÙƒØ¨ Ù†ÙØ³Ù‡ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­) */
function cancelMyRequest() {
  const key = myRequestKey || localStorage.getItem('myRequestKey');
  if (!key) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù„Ø§Ù„ØºØ§Ø¡Ù‡'); return; }
  window.update(window.ref(window.db, `tripRequests/${key}`), { status:'cancelled', cancelledAt: Date.now() });
  showNotification('ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©','Ù„Ù‚Ø¯ Ø£Ù„ØºÙŠÙ‘Øª Ø·Ù„Ø¨Ùƒ','error');
  localStorage.removeItem('myRequestKey'); myRequestKey = null;
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§Ø± Ù…Ø±Ø³ÙˆÙ…
  if (routeControl) { currentMap.removeControl(routeControl); routeControl = null; }
}

/* Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª */
function watchTripRequests() {
  const requestsRef = window.ref(window.db, 'tripRequests');
  window.onValue(requestsRef, snapshot => {
    const requests = snapshot.val();
    if (!requests) return;
    Object.keys(requests).forEach(requestId => {
      const r = requests[requestId];
      r.id = requestId; // Ø¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ø§Ù„ÙƒØ§Ø¦Ù†
      // Ù„Ù„Ø³Ø§Ø¦Ù‚: Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
      if (window.currentRole === 'sayeq' && r.driverId === window.currentUser.uid && r.status === 'pending') {
        showTripRequestNotification(r, requestId);
      }
      // Ù„Ù„Ø±Ø§ÙƒØ¨: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
      if (window.currentRole === 'rakib' && r.passengerId === window.currentUser.uid) {
        updateTripStatus(r);
      }
    });
  });
}

/* Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ */
function showTripRequestNotification(request, requestId) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  const dist = request.passengerLocation && currentLocation ? calculateDistance(currentLocation.lat,currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1) : '---';
  notification.innerHTML = `
    <div class="notification-title">ğŸš— Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</div>
    <div class="notification-content">Ø§Ù„Ø±Ø§ÙƒØ¨: ${escapeHtml(request.passengerName)}<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist} ÙƒÙ…</div>
    <div class="notification-actions">
      <button class="accept-btn" onclick="acceptTrip('${requestId}')">Ù‚Ø¨ÙˆÙ„</button>
      <button class="reject-btn" onclick="rejectTrip('${requestId}')">Ø±ÙØ¶</button>
    </div>`;
  document.body.appendChild(notification);
  // Ø§Ø²Ø§Ù„ØªÙ‡ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© Ø§Ø°Ø§ Ù„Ù… ÙŠÙØªØ®Ø° Ù‚Ø±Ø§Ø±
  setTimeout(()=>{ if (notification.parentNode) notification.parentNode.removeChild(notification); }, 30000);
}

/* Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© (Ø³Ø§Ø¦Ù‚) â€” ÙŠØ­Ø¯Ø«: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ØŒ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±ØŒ ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù„Ø±Ø§ÙƒØ¨ */
function acceptTrip(requestId) {
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'accepted', acceptedAt: Date.now() });

  // Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const seatsInput = document.getElementById('availableSeats');
  if (seatsInput) {
    let seats = parseInt(seatsInput.value || 0);
    if (seats > 0) {
      seats = seats - 1;
      seatsInput.value = seats;
      window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), { availableSeats: seats });
    }
  }

  // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±
  window.get(window.ref(window.db, `tripRequests/${requestId}`)).then(snap=>{
    if (!snap.exists()) return;
    const request = snap.val();
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
    if (currentLocation && request.passengerLocation) {
      if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(currentLocation.lat, currentLocation.lng),
          L.latLng(request.passengerLocation.lat, request.passengerLocation.lng)
        ],
        showAlternatives: false,
        addWaypoints: false,
        draggableWaypoints: false,
        routeWhileDragging: false,
        createMarker: function() { return null; } // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø§ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ©
      }).addTo(currentMap);

      // Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±ØŒ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙ†Ø­Ø¯Ù‘Ø« Ø«Ù…Ù† Ø§Ù„Ø±Ø­Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      routeControl.on('routesfound', function(e) {
        const routes = e.routes;
        if (routes && routes.length>0) {
          const summary = routes[0].summary; // distance meter, time sec
          const distKm = Math.round((summary.totalDistance/1000)*10)/10; // ÙˆØ§Ø­Ø¯ Ø¹Ø´Ø±ÙŠ
          document.getElementById('distanceInput').value = distKm;
          calculatePrice();
          // Ù†Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø±Ø§ÙƒØ¨ ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚
          showNotification('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©','ØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©: '+distKm+' ÙƒÙ…','success');
        }
      });
    }

    // Ø§ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø§Ù„Ø³Ø§Ø¦Ù‚)
    startChat(request.passengerId, request.passengerName || "Ø§Ù„Ø±Ø§ÙƒØ¨");
  });

  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¸Ù‡Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
  document.querySelectorAll('.notification').forEach(n=>n.remove());
}

/* Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø© */
function rejectTrip(requestId) {
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'rejected', rejectedAt: Date.now() });
  document.querySelectorAll('.notification').forEach(n=>n.remove());
}

/* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© - ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙ†ÙØ°Ù‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£ÙŠØ¶Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙ†ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±) */
function cancelTrip(requestId) {
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'cancelled', cancelledAt: Date.now() });
  showNotification("ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©","ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­","error");
  if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
}

/* ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø±Ø§ÙƒØ¨ (ØªØ¹Ø±Ø¶ Ø²Ø± Ø¥Ù„ØºØ§Ø¡) */
function updateTripStatus(request) {
  const statusDiv = document.getElementById('tripStatus');
  const statusText = document.getElementById('tripStatusText');

  if (request.status === 'pending') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = `â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚... <br>
      <button onclick="cancelTrip('${request.id}')" style="margin-top:8px;background:#e53e3e;color:white;border:none;padding:6px 12px;border-radius:6px;">ğŸš« Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>`;
    statusDiv.className = 'trip-status';
    // Ø®Ø²Ù‘Ù† Ù…ÙØªØ§Ø­ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§
    localStorage.setItem('myRequestKey', request.id);
    myRequestKey = request.id;
  } else if (request.status === 'accepted') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ <br>
      <button onclick="cancelTrip('${request.id}')" style="margin-top:8px;background:#e53e3e;color:white;border:none;padding:6px 12px;border-radius:6px;">ğŸš« Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>`;
    statusDiv.className = 'trip-status active';
    // Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø±Ø§ÙƒØ¨ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
    startChat(request.driverId, "Ø§Ù„Ø³Ø§Ø¦Ù‚");
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  } else if (request.status === 'rejected') {
    statusDiv.style.display = 'block';
    statusText.textContent = 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±';
    statusDiv.className = 'trip-status';
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  } else if (request.status === 'cancelled') {
    statusDiv.style.display = 'block';
    statusText.textContent = 'ğŸš« Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙÙ„ØºÙŠØª';
    statusDiv.className = 'trip-status';
    if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  }
}

/* Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù… */
function showNotification(title, content, type) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.innerHTML = `<div class="notification-title">${title}</div><div class="notification-content">${content}</div>`;
  document.body.appendChild(notification);
  setTimeout(()=>{ if (notification.parentNode) notification.parentNode.removeChild(notification); }, 5000);
}

/* ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…ØªØ§Ø­/Ù…Ø´ØºÙˆÙ„) */
function updateDriverStatus() {
  const status = document.getElementById('driverStatus').value;
  if (window.currentUser && currentLocation) {
    window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), { status: status });
  }
}

/* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø²Ø±) */
function activateRide() {
  if (window.currentRole === 'rakib') {
    showMessage('success','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†...');
  } else {
    const status = document.getElementById('driverStatus').value;
    if (status === 'available') showMessage('success','ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');
    else showMessage('error','ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ "Ù…ØªØ§Ø­" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©');
  }
}

/* Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ù…Ù„Ù */
function submitPassengerInfo() {
  const name = document.getElementById('passengerName').value.trim();
  const phone = document.getElementById('passengerPhone').value.trim();
  const idCardFile = document.getElementById('passengerIdCard').files[0];
  if (!name || !phone || !idCardFile) { showMessage('error','ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','passenger'); return; }

  validateImageFile(idCardFile).then(valid=>{
    if (!valid) { showMessage('error','ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù…Ù„Ù JPG/JPEG/PNG ÙˆØ£Ù‚ØµÙ‰ Ø­Ø¬Ù… 5 Ù…ÙŠØºØ§Ø¨Ø§ÙŠØª ÙˆØ£Ø¨Ø¹Ø§Ø¯ Ù…Ø¹Ù‚ÙˆÙ„Ø©.','passenger'); return; }
    localStorage.setItem('passengerData', JSON.stringify({ name, phone }));
    window.update(window.ref(window.db, `users/${window.currentUser.uid}`), { name, phone, profileComplete:true }).then(()=>{
      showMessage('success','ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!','passenger');
      setTimeout(()=>{ showPage('mapPage'); loadMap(name); startLocationTracking(); }, 1200);
    });
  });
}

/* Ø¨Ø¯Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ â€” Ù…Ø¹ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ */
function startDriverMap() {
  const name = document.getElementById('driverName').value.trim();
  const phone = document.getElementById('driverPhone').value.trim();
  const carType = document.getElementById('carType').value.trim();
  const carColor = document.getElementById('carColor').value.trim();
  const plateNumber = document.getElementById('plateNumber').value.trim();
  const driverIdFile = document.getElementById('driverId').files[0];
  const carCheckFile = document.getElementById('carCheck').files[0];

  if (!name || !phone || !carType || !carColor || !plateNumber || !driverIdFile || !carCheckFile) {
    showMessage('error','ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','driver'); return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ§Ù„Ø­ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª (Ø§Ø«Ù†Ø§Ù†)
  Promise.all([ validateImageFile(driverIdFile), validateImageFile(carCheckFile) ])
    .then(results => {
      if (!results.every(Boolean)) {
        showMessage('error','Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ± JPG/JPEG/PNG ØµØºÙŠØ±Ø© Ø§Ù„Ø­Ø¬Ù… ÙˆØ¨Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ø¶Ø­Ø©.','driver'); return;
      }
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
      localStorage.setItem('driverData', JSON.stringify({ name, phone, carType, carColor, plateNumber }));
      window.update(window.ref(window.db, `users/${window.currentUser.uid}`), { name, phone, carType, carColor, plateNumber, profileComplete:true }).then(()=>{
        showMessage('success','ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!','driver');
        setTimeout(()=>{ showPage('mapPage'); loadMap(name); startLocationTracking(); },1200);
      });
    });
}

/* Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯ */
function showDeclaration() {
  const declarationBox = document.getElementById('declarationBox');
  declarationBox.innerHTML = `
    <h4>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
    <p>Ø£ØªØ¹Ù‡Ø¯ Ø¨Ø£Ù†:</p>
    <ul style="text-align:right;">
      <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ØµØ­ÙŠØ­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©</li>
      <li>Ø³ÙŠØ§Ø±ØªÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
      <li>Ø£Ø­Ù…Ù„ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„</li>
      <li>Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªÙˆÙÙŠØ± Ø®Ø¯Ù…Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…Ù‡Ø°Ø¨Ø© Ù„Ù„Ø±ÙƒØ§Ø¨</li>
      <li>Ø³Ø£Ø­ØªØ±Ù… Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</li>
    </ul>`;
  declarationBox.style.display = 'block';
}

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
function logout() {
  if (window.currentUser) {
    window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), null).catch(()=>{});
  }
  window.currentUser = null; window.currentRole = null; localStorage.clear();
  showPage('loginPage');
}

/* Ù…Ø³Ø§Ø¹Ø¯: Ø¯Ø±Ø¬ Ø§Ø³ØªÙ…Ø§Ø¹ Enter Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
document.addEventListener('DOMContentLoaded', function() {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) chatInput.addEventListener('keypress', function(e){ if (e.key === 'Enter') sendMessage(); });
});

/* ===== ÙØ§Ø­Øµ Ø§Ù„ØµÙˆØ±: Ù†ÙˆØ¹/Ø­Ø¬Ù…/Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø³ÙŠØ·Ø© =====
   ÙŠØ¹ÙŠØ¯ Promise<boolean>
*/
function validateImageFile(file) {
  return new Promise((resolve) => {
    if (!file) return resolve(false);
    const allowed = ['image/jpeg','image/jpg','image/png'];
    if (!allowed.includes(file.type)) return resolve(false);
    const maxBytes = 5 * 1024 * 1024; // 5 MB
    if (file.size > maxBytes) return resolve(false);

    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù„ÙŠØ³Øª ØµÙØ±ÙŠØ© ÙˆØ£Ù† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ø¨Ø¯Ø±Ø¬Ø© Ø¨Ø³ÙŠØ·Ø©
    const fr = new FileReader();
    fr.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        // Ù†Ø·Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¹Ø±Ø¶ 200px ÙˆØ§Ø±ØªÙØ§Ø¹ 100px ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
        if (img.width < 200 || img.height < 100) return resolve(false);
        return resolve(true);
      };
      img.onerror = function(){ return resolve(false); };
      img.src = e.target.result;
    };
    fr.onerror = function(){ resolve(false); };
    fr.readAsDataURL(file);
  });
}

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù„ØºØ§Ø¡ XSS Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙÙŠ HTML ===== */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
</script>
</body>
</html>
