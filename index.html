<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GRASIAS - كامل</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
  direction: rtl; padding:20px;
}
.box { background:white; padding:30px 25px; border-radius:20px; box-shadow:0 15px 50px rgba(0,0,0,0.2); width:100%; max-width:400px; text-align:center; animation:fadeIn .6s ease-in-out; }
@keyframes fadeIn { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
h2{ margin-bottom:25px; color:#4a5568; font-weight:600; font-size:24px; }
input, button, textarea, select { width:100%; padding:15px; border-radius:12px; margin-bottom:15px; font-size:16px; border:2px solid #e2e8f0; transition:all .3s; }
input:focus, textarea:focus, select:focus { border-color:#667eea; outline:none; box-shadow:0 0 0 3px rgba(102,126,234,.1); }
button { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; cursor:pointer; font-weight:600; transition:transform .2s; }
button:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,.3); }
.choice{ text-align:right; margin:25px 0; }
.choice label{ display:flex; align-items:center; margin-bottom:12px; font-size:16px; cursor:pointer; padding:10px; border-radius:8px; }
.declaration-box { margin-top:20px; background:#f8f9fa; padding:20px; border-radius:12px; text-align:right; display:none; border-right:4px solid #667eea; line-height:1.6; }

#mapPage { display:none; height:100vh; width:100vw; flex-direction:row; position:fixed; top:0; left:0; right:0; bottom:0; }
#map { width:65%; height:100vh; }
.sidebar { width:35%; background:#fff; padding:30px; overflow-y:auto; box-shadow:-2px 0 10px rgba(0,0,0,.1); }
.sidebar h3{ color:#4a5568; margin-bottom:20px; font-size:20px; text-align:right; }

#passengerPage,#driverPage,#mapPage{ display:none; }

.file-input-wrapper { position:relative; margin-bottom:15px; }
.file-input-wrapper input[type="file"] { opacity:0; position:absolute; z-index:-1; }
.file-input-label { display:block; padding:15px; background:#f8f9fa; border:2px dashed #cbd5e0; border-radius:12px; text-align:center; cursor:pointer; transition:all .3s; }
.file-input-label:hover { border-color:#667eea; background:#edf2f7; }

.success-message { background:#c6f6d5; color:#22543d; padding:12px; border-radius:8px; margin-bottom:15px; display:none; }
.error-message { background:#fed7d7; color:#742a2a; padding:12px; border-radius:8px; margin-bottom:15px; display:none; }

.driver-card { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,.1); border:2px solid transparent; cursor:pointer; transition:all .3s; }
.driver-card:hover { border-color:#667eea; transform:translateY(-2px); }
.driver-card.selected { border-color:#48bb78; background:#f0fff4; }
.driver-info { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.driver-name { font-weight:600; color:#2d3748; font-size:16px; }
.driver-distance { background:#667eea; color:white; padding:4px 8px; border-radius:6px; font-size:12px; }

.driver-actions { display:flex; gap:10px; }
.action-btn { flex:1; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; }
.call-btn { background:#48bb78; color:white; }
.chat-btn { background:#4299e1; color:white; }
.select-btn { background:#667eea; color:white; }

.notification { position:fixed; top:20px; right:20px; background:white; padding:20px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.15); border-right:4px solid #667eea; z-index:1000; max-width:350px; animation:slideIn .3s ease-out; }
@keyframes slideIn { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
.notification-title{ font-weight:600; color:#2d3748; margin-bottom:10px; }
.notification-content{ color:#4a5568; margin-bottom:15px; line-height:1.5; }
.notification-actions { display:flex; gap:10px; }
.accept-btn { background:#48bb78; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; }
.reject-btn { background:#e53e3e; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; }

.chat-container { position:fixed; bottom:20px; right:20px; width:320px; height:420px; background:white; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.15); display:none; flex-direction:column; z-index:1000; }
.chat-header { background:#667eea; color:white; padding:15px; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center; }
.chat-messages { flex:1; padding:15px; overflow-y:auto; max-height:250px; }
.chat-input-container { padding:15px; border-top:1px solid #e2e8f0; display:flex; gap:10px; }
.chat-input { flex:1; padding:8px 12px; border:1px solid #e2e8f0; border-radius:8px; margin:0; }
.send-btn { background:#667eea; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; margin:0; width:auto; }

.message { margin-bottom:10px; padding:8px 12px; border-radius:8px; max-width:80%; }
.message.sent { background:#667eea; color:white; margin-left:auto; text-align:left; }
.message.received { background:#f7fafc; color:#2d3748; margin-right:auto; }

.trip-status { background:#e6fffa; border:1px solid #81e6d9; border-radius:8px; padding:15px; margin-bottom:15px; text-align:center; }
.trip-status.active { background:#f0fff4; border-color:#9ae6b4; }

.distance-calculator { background:#f8f9fa; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-bottom:15px; }
.distance-input { display:flex; gap:10px; margin-bottom:10px; }
.distance-input input { flex:1; margin:0; }
.price-display { background:#667eea; color:white; padding:10px; border-radius:8px; text-align:center; font-weight:600; font-size:18px; }

.driver-popup { background:white; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); min-width:200px; }
.driver-popup h4 { margin:0 0 10px 0; color:#2d3748; font-size:16px; }
.driver-popup p { margin:5px 0; color:#4a5568; font-size:14px; }

@media (max-width:768px) {
  #mapPage { flex-direction:column; }
  #map { width:100%; height:60vh; }
  .sidebar { width:100%; height:40vh; padding:20px; }
  .chat-container { width:90%; right:5%; left:5%; }
  .notification { right:10px; left:10px; max-width:none; }
}
</style>
</head>
<body>
<!-- صفحة تسجيل الدخول -->
<div class="box" id="loginPage">
  <h2>مرحباً بك في GRASIAS</h2>
  <div class="choice">
    <label><input type="radio" name="role" value="sayeq"> <span>🚗 سائق</span></label>
    <label><input type="radio" name="role" value="rakib"> <span>🧍‍♀️ راكب</span></label>
  </div>
  <button onclick="signInWithGoogle()">🔐 تسجيل الدخول باستخدام Google</button>
</div>

<!-- صفحة معلومات الراكب -->
<div class="box" id="passengerPage">
  <h2>معلومات الراكب</h2>
  <div class="success-message" id="passengerSuccess"></div>
  <div class="error-message" id="passengerError"></div>
  <input type="text" id="passengerName" placeholder="الاسم الكامل" required>
  <input type="tel" id="passengerPhone" placeholder="رقم الهاتف (مثال: 0612345678)" required>
  <div class="file-input-wrapper">
    <input type="file" id="passengerIdCard" accept="image/*" />
    <label for="passengerIdCard" class="file-input-label">📄 اختر صورة بطاقة الهوية</label>
  </div>
  <button onclick="submitPassengerInfo()">متابعة ➡️</button>
</div>

<!-- صفحة معلومات السائق -->
<div class="box" id="driverPage">
  <h2>معلومات السائق</h2>
  <div class="success-message" id="driverSuccess"></div>
  <div class="error-message" id="driverError"></div>
  <input type="text" id="driverName" placeholder="الاسم الكامل" required>
  <input type="tel" id="driverPhone" placeholder="رقم الهاتف (مثال: 0612345678)" required>
  <input type="text" id="carType" placeholder="نوع السيارة (مثال: تويوتا كورولا)" required>
  <input type="text" id="carColor" placeholder="لون السيارة" required>
  <input type="text" id="plateNumber" placeholder="رقم لوحة السيارة" required>
  <div class="file-input-wrapper">
    <input type="file" id="driverId" accept="image/*" required>
    <label for="driverId" class="file-input-label">📄 اختر صورة بطاقة الهوية</label>
  </div>
  <div class="file-input-wrapper">
    <input type="file" id="carCheck" accept="image/*" required>
    <label for="carCheck" class="file-input-label">🔧 اختر صورة التشخيص التقني</label>
  </div>
  <button onclick="showDeclaration()">📜 عرض التعهد</button>
  <div class="declaration-box" id="declarationBox"></div>
  <button onclick="startDriverMap()">متابعة ➡️</button>
</div>

<!-- صفحة الخريطة -->
<div id="mapPage">
  <div id="map"></div>
  <div class="sidebar">
    <div id="tripStatus" class="trip-status" style="display:none;">
      <div id="tripStatusText"></div>
    </div>
    <h3 id="sidebarTitle">🚗 تفاصيل الرحلة</h3>

    <!-- محتوى الراكب -->
    <div id="passengerContent">
      <div id="nearbyDrivers">
        <h4 style="text-align:right">السائقون القريبون:</h4>
        <div id="driversList"></div>
      </div>
      <div style="margin-top:10px;">
        <button onclick="cancelMyRequest()" style="background:#e53e3e">🚫 إلغاء طلبي (إذا كان موجوداً)</button>
      </div>
    </div>

    <!-- محتوى السائق -->
    <div id="driverContent" style="display:none;">
      <label>حالة السائق:</label>
      <select id="driverStatus" onchange="updateDriverStatus()">
        <option value="available">متاح</option>
        <option value="busy">مشغول</option>
        <option value="offline">غير متصل</option>
      </select>

      <label>عدد المقاعد المتاحة:</label>
      <input type="number" id="availableSeats" min="1" max="8" value="4">

      <label>ملاحظات السائق:</label>
      <textarea id="driverNotes" placeholder="معلومات إضافية للركاب..." style="height:60px;"></textarea>

      <!-- حاسبة المسافة والثمن -->
      <div class="distance-calculator">
        <h4>حاسبة الثمن:</h4>
        <div class="distance-input">
          <input type="number" id="distanceInput" placeholder="المسافة (كم)" min="1" onchange="calculatePrice()">
        </div>
        <div id="priceDisplay" class="price-display" style="display:none;">
          الثمن: <span id="calculatedPrice">0</span> دينار
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button onclick="activateRide()" id="activateBtn">🚗 تفعيل الرحلة</button>
      <button onclick="logout()" style="background:#e53e3e; margin-top:10px;">🚪 تسجيل الخروج</button>
    </div>
    <hr style="margin:15px 0;">
    <div style="text-align:right">
      <label style="font-weight:700">طبقات الخريطة:</label>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button onclick="setBaseLayer('osm')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">🗺️ طرق</button>
        <button onclick="setBaseLayer('sat')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">🛰️ صور</button>
        <button onclick="setBaseLayer('toner')" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0;">🖤 قلم</button>
      </div>
    </div>

  </div>
</div>

<!-- نافذة الدردشة -->
<div id="chatContainer" class="chat-container">
  <div class="chat-header">
    <span id="chatTitle">الدردشة</span>
    <button onclick="closeChat()" style="background:none;border:none;color:white;cursor:pointer;padding:0;margin:0;width:auto;">✕</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input-container">
    <input type="text" id="chatInput" class="chat-input" placeholder="اكتب رسالتك...">
    <button onclick="sendMessage()" class="send-btn">إرسال</button>
  </div>
</div>

<!-- Firebase (module) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
  authDomain: "grasias-d7830.firebaseapp.com",
  databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "grasias-d7830",
  storageBucket: "grasias-d7830.appspot.com",
  messagingSenderId: "134413476604",
  appId: "1:134413476604:web:ab1acfa69c025218cbad79",
  measurementId: "G-6QBYM41CJ1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// جعل المتغيرات متاحة عالمياً
window.currentUser = null;
window.currentRole = null;
window.db = db;
window.auth = auth;
window.ref = ref;
window.set = set;
window.get = get;
window.update = update;
window.push = push;
window.onValue = onValue;

// تسجيل الدخول
window.signInWithGoogle = () => {
  const roleInput = document.querySelector('input[name="role"]:checked');
  if (!roleInput) { alert("يرجى اختيار الدور قبل تسجيل الدخول"); return; }
  window.currentRole = roleInput.value;

  signInWithPopup(auth, provider)
    .then((result) => {
      const user = result.user;
      window.currentUser = user;
      const userRef = ref(db, `users/${user.uid}`);
      get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          if (userData.role) window.currentRole = userData.role;
          showPage("mapPage");
          loadMap(user.displayName);
          startLocationTracking();
        } else {
          set(userRef, { name: user.displayName, email: user.email, role: window.currentRole, createdAt: new Date().toISOString() })
            .then(() => {
              if (window.currentRole === "rakib") showPage("passengerPage"); else showPage("driverPage");
            });
        }
      });
    })
    .catch((error) => { console.error("خطأ في تسجيل الدخول:", error); alert("فشل تسجيل الدخول: " + error.message); });
};
</script>

<!-- Leaflet & Routing scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ===== متغيرات الخريطة والحالة ===== */
let currentMap = null;
let currentMarker = null;
let driversMarkers = [];
let passengersMarkers = [];
let currentLocation = null;
let selectedDriver = null;
let currentTrip = null;
let routeControl = null;
let currentChatPartner = null;
let baseLayers = {};
let activeBaseLayerKey = 'osm';
let myRequestKey = null; // مفتاح طلب الراكب الحالي (إذا موجود) لتسهيل الإلغاء

/* أيقونات */
const driverIcon = L.divIcon({ html: '🚗', iconSize: [30,30], className: 'custom-div-icon' });
const passengerIcon = L.divIcon({ html: '🧍‍♀️', iconSize: [30,30], className: 'custom-div-icon' });

/* مساعد عرض الصفحات */
function showPage(id) {
  ["loginPage","passengerPage","driverPage","mapPage"].forEach(p => document.getElementById(p).style.display = "none");
  document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
}

/* رسائل نجاح/خطأ */
function showMessage(type, message, pagePrefix='') {
  const successEl = document.getElementById(pagePrefix + 'Success');
  const errorEl = document.getElementById(pagePrefix + 'Error');
  if (type === 'success') {
    if (successEl) { successEl.textContent = message; successEl.style.display='block'; }
    if (errorEl) errorEl.style.display='none';
  } else {
    if (errorEl) { errorEl.textContent = message; errorEl.style.display='block'; }
    if (successEl) successEl.style.display='none';
  }
  setTimeout(()=>{ if (successEl) successEl.style.display='none'; if (errorEl) errorEl.style.display='none'; },5000);
}

/* حساب الثمن (نفس المنطق السابق) */
function calculatePrice() {
  const distance = parseFloat(document.getElementById('distanceInput').value);
  if (!distance || distance <= 0) { document.getElementById('priceDisplay').style.display='none'; return; }
  let totalPrice = 0;
  if (distance <= 20) totalPrice = distance * 10;
  else if (distance <= 50) totalPrice = (20*10) + ((distance-20)*5);
  else totalPrice = (20*10) + (30*5) + ((distance-50)*2);
  document.getElementById('calculatedPrice').textContent = totalPrice;
  document.getElementById('priceDisplay').style.display = 'block';
}

/* ===== إعداد الخريطة والطبقات ===== */
function loadMap(userName) {
  if (currentMap) currentMap.remove();

  currentMap = L.map('map').setView([28.0339,1.6596],6);

  // Base layers
  baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(currentMap);
  baseLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
  baseLayers.toner = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', { attribution: 'Stamen' });

  L.control.scale({ position: 'bottomleft' }).addTo(currentMap);

  // Layer control (عرض سريع)
  L.control.layers({
    "خرائط (OSM)": baseLayers.osm,
    "صور فضائية": baseLayers.sat,
    "قلم (Toner)": baseLayers.toner
  }, {}, { position: 'bottomright' }).addTo(currentMap);

  // تأقلم واجهة حسب الدور
  if (window.currentRole === 'rakib') {
    document.getElementById('passengerContent').style.display = 'block';
    document.getElementById('driverContent').style.display = 'none';
    document.getElementById('sidebarTitle').textContent = '🧍‍♀️ البحث عن سائق';
    document.getElementById('activateBtn').textContent = '🔍 البحث عن سائق';
  } else {
    document.getElementById('passengerContent').style.display = 'none';
    document.getElementById('driverContent').style.display = 'block';
    document.getElementById('sidebarTitle').textContent = '🚗 لوحة السائق';
    document.getElementById('activateBtn').textContent = '🚗 تفعيل الخدمة';
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude, lng = position.coords.longitude;
      currentLocation = { lat, lng };
      currentMap.setView([lat,lng],14);

      if (currentMarker) currentMap.removeLayer(currentMarker);
      const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
      currentMarker = L.marker([lat,lng], { icon }).addTo(currentMap).bindPopup(`📍 ${userName}`).openPopup();

      startLocationTracking(); // يبدأ التتبع
    }, (err)=>{ console.error("خطأ تحديد موقع:",err); alert("⚠️ تعذر تحديد موقعك. تأكد من تشغيل GPS"); });
  } else { alert("⚠️ المتصفح لا يدعم تحديد الموقع."); }
}

/* تبديل الطبقة الأساسية */
function setBaseLayer(key) {
  if (!baseLayers[key]) return;
  if (activeBaseLayerKey && baseLayers[activeBaseLayerKey]) currentMap.removeLayer(baseLayers[activeBaseLayerKey]);
  baseLayers[key].addTo(currentMap);
  activeBaseLayerKey = key;
}

/* تتبع الموقع وتحديثه في Firebase كل 10 ثواني */
function startLocationTracking() {
  if (!window.currentUser) return;

  // إرسال تحديث فوري أولًا
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos=>{
      const newLocation = buildLocationObject(pos.coords);
      window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);
      currentLocation = { lat:newLocation.lat, lng:newLocation.lng };
      if (currentMarker) currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
    });
  }

  setInterval(()=> {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const newLocation = buildLocationObject(position.coords);
        window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);
        currentLocation = { lat:newLocation.lat, lng:newLocation.lng };
        if (currentMarker) currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
      });
    }
  }, 10000);

  if (window.currentRole === 'rakib') watchDrivers(); else watchPassengers();
  watchTripRequests();
}

function buildLocationObject(coords) {
  const obj = { lat: coords.latitude, lng: coords.longitude, role: window.currentRole, name: window.currentUser.displayName, timestamp: Date.now(), status: window.currentRole === 'sayeq' ? (document.getElementById('driverStatus')?.value || 'available') : 'active' };
  if (window.currentRole === 'sayeq') {
    const driverData = JSON.parse(localStorage.getItem('driverData')||'{}');
    obj.phone = driverData.phone || '';
    obj.carType = driverData.carType || '';
    obj.carColor = driverData.carColor || '';
    obj.plateNumber = driverData.plateNumber || '';
    obj.availableSeats = parseInt(document.getElementById('availableSeats')?.value || 4);
    obj.notes = document.getElementById('driverNotes')?.value || '';
  }
  return obj;
}

/* مراقبة السائقين للراكب */
function watchDrivers() {
  const driversRef = window.ref(window.db, 'locations');
  window.onValue(driversRef, snapshot => {
    const locations = snapshot.val();
    updateDriversOnMap(locations);
    updateDriversList(locations);
  });
}

/* مراقبة الركاب للسائق */
function watchPassengers() {
  const passengersRef = window.ref(window.db, 'locations');
  window.onValue(passengersRef, snapshot => {
    const locations = snapshot.val();
    updatePassengersOnMap(locations);
  });
}

/* تحديث السائقين على الخريطة */
function updateDriversOnMap(locations) {
  driversMarkers.forEach(m => currentMap.removeLayer(m));
  driversMarkers = [];
  if (!locations) return;
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
      const marker = L.marker([location.lat, location.lng], { icon: driverIcon }).addTo(currentMap);
      const popupContent = `
        <div class="driver-popup">
          <h4>🚗 ${location.name}</h4>
          <p><strong>📞 الهاتف:</strong> ${location.phone || 'غير متوفر'}</p>
          <p><strong>🚙 نوع السيارة:</strong> ${location.carType || 'غير محدد'}</p>
          <p><strong>🎨 لون السيارة:</strong> ${location.carColor || 'غير محدد'}</p>
          <p><strong>🔢 رقم اللوحة:</strong> ${location.plateNumber || 'غير متوفر'}</p>
          <p><strong>💺 المقاعد المتاحة:</strong> ${location.availableSeats || 4}</p>
          ${location.notes ? `<p><strong>📝 ملاحظات:</strong> ${location.notes}</p>` : ''}
        </div>`;
      marker.bindPopup(popupContent);
      marker.userId = userId;
      driversMarkers.push(marker);
    }
  });
}

/* تحديث الركاب على الخريطة */
function updatePassengersOnMap(locations) {
  passengersMarkers.forEach(m => currentMap.removeLayer(m));
  passengersMarkers = [];
  if (!locations) return;
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'rakib' && userId !== window.currentUser?.uid) {
      const marker = L.marker([location.lat, location.lng], { icon: passengerIcon }).addTo(currentMap);
      const popupContent = `<div class="driver-popup"><h4>🧍‍♀️ ${location.name}</h4><p><strong>📍 الموقع:</strong> راكب يبحث عن رحلة</p></div>`;
      marker.bindPopup(popupContent);
      marker.userId = userId;
      passengersMarkers.push(marker);
    }
  });
}

/* تحديث قائمة السائقين في الشريط الجانبي (رتب حسب المسافة) */
function updateDriversList(locations) {
  const driversList = document.getElementById('driversList');
  if (!driversList) return;
  driversList.innerHTML = '';
  if (!locations || !currentLocation) return;
  const availableDrivers = [];
  Object.keys(locations).forEach(userId => {
    const location = locations[userId];
    if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
      const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
      availableDrivers.push({ ...location, userId, distance });
    }
  });
  availableDrivers.sort((a,b)=>a.distance-b.distance);
  availableDrivers.forEach(driver => {
    const driverCard = document.createElement('div');
    driverCard.className = 'driver-card';
    driverCard.innerHTML = `
      <div class="driver-info">
        <span class="driver-name">🚗 ${driver.name}</span>
        <span class="driver-distance">${driver.distance.toFixed(1)} كم</span>
      </div>
      <div class="car-info">🚙 ${driver.carType||'غير محدد'} - 🎨 ${driver.carColor||'غير محدد'}<br>💺 ${driver.availableSeats||4} مقاعد متاحة</div>
      <div class="driver-actions">
        <button class="action-btn call-btn" onclick="callDriver('${driver.phone}')">📞 اتصال</button>
        <button class="action-btn chat-btn" onclick="startChat('${driver.userId}','${escapeHtml(driver.name)}')">💬 دردشة</button>
        <button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">✅ اختيار</button>
      </div>`;
    driversList.appendChild(driverCard);
  });
  if (availableDrivers.length === 0) {
    driversList.innerHTML = '<p style="text-align:center;color:#718096">لا يوجد سائقون متاحون في المنطقة</p>';
  }
}

/* هافرسال رقمي بسيط لحساب المسافة (Haversine) */
function calculateDistance(lat1,lng1,lat2,lng2) {
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function callDriver(phone) {
  if (phone && phone !== 'غير متوفر') window.open(`tel:${phone}`,'_self'); else alert('رقم الهاتف غير متوفر');
}

/* ===== الدردشة ===== */
function startChat(userId, userName) {
  currentChatPartner = { userId, userName };
  document.getElementById('chatTitle').textContent = `دردشة مع ${userName}`;
  document.getElementById('chatContainer').style.display = 'flex';
  loadChatMessages(userId);
}

function closeChat() { document.getElementById('chatContainer').style.display='none'; currentChatPartner = null; }

function loadChatMessages(partnerId) {
  if (!window.currentUser) return;
  const chatId = [window.currentUser.uid, partnerId].sort().join('_');
  const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);
  window.onValue(messagesRef, (snapshot) => {
    const messages = snapshot.val();
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    if (messages) {
      Object.keys(messages).forEach(messageId => {
        const message = messages[messageId];
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent':'received'}`;
        messageDiv.textContent = `${message.text}`;
        chatMessages.appendChild(messageDiv);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
}

function sendMessage() {
  const chatInput = document.getElementById('chatInput');
  const messageText = chatInput.value.trim();
  if (!messageText || !currentChatPartner) return;
  const chatId = [window.currentUser.uid, currentChatPartner.userId].sort().join('_');
  const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);
  window.push(messagesRef, { text: messageText, senderId: window.currentUser.uid, senderName: window.currentUser.displayName, timestamp: Date.now() });
  chatInput.value='';
}

/* ===== اختيار سائق (طلب الرحلة) ===== */
function selectDriver(driverId) {
  selectedDriver = driverId;
  if (!window.currentUser || !currentLocation) { alert("موقعك غير متاح بعد"); return; }
  const tripRequest = {
    passengerId: window.currentUser.uid,
    passengerName: window.currentUser.displayName,
    passengerLocation: currentLocation,
    driverId: driverId,
    status: 'pending',
    timestamp: Date.now()
  };
  // احفظ المفتاح (key) لكي نتمكن من الإلغاء لاحقًا
  const newRef = window.push(window.ref(window.db, 'tripRequests'), tripRequest);
  myRequestKey = newRef.key;
  // خزّن محليًا أيضًا
  localStorage.setItem('myRequestKey', myRequestKey);
  showNotification('تم إرسال طلب الرحلة','في انتظار موافقة السائق...','info');
}

/* إلغاء طلب الراكب نفسه (باستخدام المفتاح) */
function cancelMyRequest() {
  const key = myRequestKey || localStorage.getItem('myRequestKey');
  if (!key) { alert('لا يوجد طلب لالغاءه'); return; }
  window.update(window.ref(window.db, `tripRequests/${key}`), { status:'cancelled', cancelledAt: Date.now() });
  showNotification('🚫 تم إلغاء الرحلة','لقد ألغيّت طلبك','error');
  localStorage.removeItem('myRequestKey'); myRequestKey = null;
  // إزالة أي مسار مرسوم
  if (routeControl) { currentMap.removeControl(routeControl); routeControl = null; }
}

/* مراقبة طلبات الرحلات */
function watchTripRequests() {
  const requestsRef = window.ref(window.db, 'tripRequests');
  window.onValue(requestsRef, snapshot => {
    const requests = snapshot.val();
    if (!requests) return;
    Object.keys(requests).forEach(requestId => {
      const r = requests[requestId];
      r.id = requestId; // ضع المفتاح في الكائن
      // للسائق: عرض طلبات الواردة
      if (window.currentRole === 'sayeq' && r.driverId === window.currentUser.uid && r.status === 'pending') {
        showTripRequestNotification(r, requestId);
      }
      // للراكب: عرض حالة الطلب
      if (window.currentRole === 'rakib' && r.passengerId === window.currentUser.uid) {
        updateTripStatus(r);
      }
    });
  });
}

/* إشعار للسائق عند وجود طلب */
function showTripRequestNotification(request, requestId) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  const dist = request.passengerLocation && currentLocation ? calculateDistance(currentLocation.lat,currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1) : '---';
  notification.innerHTML = `
    <div class="notification-title">🚗 طلب رحلة جديد</div>
    <div class="notification-content">الراكب: ${escapeHtml(request.passengerName)}<br>المسافة: ${dist} كم</div>
    <div class="notification-actions">
      <button class="accept-btn" onclick="acceptTrip('${requestId}')">قبول</button>
      <button class="reject-btn" onclick="rejectTrip('${requestId}')">رفض</button>
    </div>`;
  document.body.appendChild(notification);
  // ازالته بعد 30 ثانية اذا لم يُتخذ قرار
  setTimeout(()=>{ if (notification.parentNode) notification.parentNode.removeChild(notification); }, 30000);
}

/* قبول الرحلة (سائق) — يحدث: تحديث الحالة، إنقاص المقاعد، رسم المسار، فتح الدردشة للراكب */
function acceptTrip(requestId) {
  // تحديث الحالة في Firebase
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'accepted', acceptedAt: Date.now() });

  // إنقاص المقاعد تلقائياً
  const seatsInput = document.getElementById('availableSeats');
  if (seatsInput) {
    let seats = parseInt(seatsInput.value || 0);
    if (seats > 0) {
      seats = seats - 1;
      seatsInput.value = seats;
      window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), { availableSeats: seats });
    }
  }

  // جلب معلومات الطلب لرسم المسار
  window.get(window.ref(window.db, `tripRequests/${requestId}`)).then(snap=>{
    if (!snap.exists()) return;
    const request = snap.val();
    // رسم المسار من السائق إلى الراكب
    if (currentLocation && request.passengerLocation) {
      if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(currentLocation.lat, currentLocation.lng),
          L.latLng(request.passengerLocation.lat, request.passengerLocation.lng)
        ],
        showAlternatives: false,
        addWaypoints: false,
        draggableWaypoints: false,
        routeWhileDragging: false,
        createMarker: function() { return null; } // نستخدم علاماتنا الخاصة
      }).addTo(currentMap);

      // عند العثور على المسار، نحسب المسافة الحقيقية ونحدّث ثمن الرحلة (اختياري)
      routeControl.on('routesfound', function(e) {
        const routes = e.routes;
        if (routes && routes.length>0) {
          const summary = routes[0].summary; // distance meter, time sec
          const distKm = Math.round((summary.totalDistance/1000)*10)/10; // واحد عشري
          document.getElementById('distanceInput').value = distKm;
          calculatePrice();
          // نعرض إشعار للراكب والسائق
          showNotification('✅ تم قبول الرحلة','تم رسم المسار والمسافة: '+distKm+' كم','success');
        }
      });
    }

    // افتح دردشة مع الراكب تلقائياً (السائق)
    startChat(request.passengerId, request.passengerName || "الراكب");
  });

  // إزالة أي إشعارات تظهر مؤقتاً
  document.querySelectorAll('.notification').forEach(n=>n.remove());
}

/* رفض الرحلة */
function rejectTrip(requestId) {
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'rejected', rejectedAt: Date.now() });
  document.querySelectorAll('.notification').forEach(n=>n.remove());
}

/* إلغاء الرحلة - يمكن أن ينفذه السائق أيضاً بعد القبول (نحدّث الحالة ونتخلص من المسار) */
function cancelTrip(requestId) {
  window.update(window.ref(window.db, `tripRequests/${requestId}`), { status:'cancelled', cancelledAt: Date.now() });
  showNotification("🚫 تم إلغاء الرحلة","تم إلغاء الرحلة بنجاح","error");
  if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
}

/* تحديث حالة الرحلة للراكب (تعرض زر إلغاء) */
function updateTripStatus(request) {
  const statusDiv = document.getElementById('tripStatus');
  const statusText = document.getElementById('tripStatusText');

  if (request.status === 'pending') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = `⏳ في انتظار موافقة السائق... <br>
      <button onclick="cancelTrip('${request.id}')" style="margin-top:8px;background:#e53e3e;color:white;border:none;padding:6px 12px;border-radius:6px;">🚫 إلغاء الرحلة</button>`;
    statusDiv.className = 'trip-status';
    // خزّن مفتاح الطلب محليًا
    localStorage.setItem('myRequestKey', request.id);
    myRequestKey = request.id;
  } else if (request.status === 'accepted') {
    statusDiv.style.display = 'block';
    statusText.innerHTML = `✅ تم قبول الرحلة! يمكنك التواصل مع السائق <br>
      <button onclick="cancelTrip('${request.id}')" style="margin-top:8px;background:#e53e3e;color:white;border:none;padding:6px 12px;border-radius:6px;">🚫 إلغاء الرحلة</button>`;
    statusDiv.className = 'trip-status active';
    // افتح الدردشة تلقائياً للراكب مع السائق
    startChat(request.driverId, "السائق");
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  } else if (request.status === 'rejected') {
    statusDiv.style.display = 'block';
    statusText.textContent = '❌ تم رفض الرحلة. يمكنك البحث عن سائق آخر';
    statusDiv.className = 'trip-status';
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  } else if (request.status === 'cancelled') {
    statusDiv.style.display = 'block';
    statusText.textContent = '🚫 الرحلة أُلغيت';
    statusDiv.className = 'trip-status';
    if (routeControl) { try { currentMap.removeControl(routeControl); } catch(e){} routeControl=null; }
    localStorage.removeItem('myRequestKey'); myRequestKey = null;
  }
}

/* إشعار عام */
function showNotification(title, content, type) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.innerHTML = `<div class="notification-title">${title}</div><div class="notification-content">${content}</div>`;
  document.body.appendChild(notification);
  setTimeout(()=>{ if (notification.parentNode) notification.parentNode.removeChild(notification); }, 5000);
}

/* تحديث حالة السائق (متاح/مشغول) */
function updateDriverStatus() {
  const status = document.getElementById('driverStatus').value;
  if (window.currentUser && currentLocation) {
    window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), { status: status });
  }
}

/* تفعيل الخدمة (زر) */
function activateRide() {
  if (window.currentRole === 'rakib') {
    showMessage('success','جاري البحث عن السائقين المتاحين...');
  } else {
    const status = document.getElementById('driverStatus').value;
    if (status === 'available') showMessage('success','تم تفعيل خدمة السائق بنجاح!');
    else showMessage('error','يجب تغيير حالتك إلى "متاح" لتفعيل الخدمة');
  }
}

/* حفظ معلومات الراكب مع فحص الملف */
function submitPassengerInfo() {
  const name = document.getElementById('passengerName').value.trim();
  const phone = document.getElementById('passengerPhone').value.trim();
  const idCardFile = document.getElementById('passengerIdCard').files[0];
  if (!name || !phone || !idCardFile) { showMessage('error','يرجى ملء جميع الحقول المطلوبة','passenger'); return; }

  validateImageFile(idCardFile).then(valid=>{
    if (!valid) { showMessage('error','صورة الهوية غير صحيحة. رجاءً اختر ملف JPG/JPEG/PNG وأقصى حجم 5 ميغابايت وأبعاد معقولة.','passenger'); return; }
    localStorage.setItem('passengerData', JSON.stringify({ name, phone }));
    window.update(window.ref(window.db, `users/${window.currentUser.uid}`), { name, phone, profileComplete:true }).then(()=>{
      showMessage('success','تم حفظ معلوماتك بنجاح!','passenger');
      setTimeout(()=>{ showPage('mapPage'); loadMap(name); startLocationTracking(); }, 1200);
    });
  });
}

/* بدء خريطة السائق — مع فحص ملفات الهوية والتشخيص */
function startDriverMap() {
  const name = document.getElementById('driverName').value.trim();
  const phone = document.getElementById('driverPhone').value.trim();
  const carType = document.getElementById('carType').value.trim();
  const carColor = document.getElementById('carColor').value.trim();
  const plateNumber = document.getElementById('plateNumber').value.trim();
  const driverIdFile = document.getElementById('driverId').files[0];
  const carCheckFile = document.getElementById('carCheck').files[0];

  if (!name || !phone || !carType || !carColor || !plateNumber || !driverIdFile || !carCheckFile) {
    showMessage('error','يرجى ملء جميع الحقول المطلوبة','driver'); return;
  }

  // تحقق من صالحية الملفات (اثنان)
  Promise.all([ validateImageFile(driverIdFile), validateImageFile(carCheckFile) ])
    .then(results => {
      if (!results.every(Boolean)) {
        showMessage('error','الصور المرفوعة غير صالحة. الرجاء رفع صور JPG/JPEG/PNG صغيرة الحجم وبأبعاد واضحة.','driver'); return;
      }
      // حفظ بيانات محليًا
      localStorage.setItem('driverData', JSON.stringify({ name, phone, carType, carColor, plateNumber }));
      window.update(window.ref(window.db, `users/${window.currentUser.uid}`), { name, phone, carType, carColor, plateNumber, profileComplete:true }).then(()=>{
        showMessage('success','تم حفظ معلوماتك بنجاح!','driver');
        setTimeout(()=>{ showPage('mapPage'); loadMap(name); startLocationTracking(); },1200);
      });
    });
}

/* عرض التعهد */
function showDeclaration() {
  const declarationBox = document.getElementById('declarationBox');
  declarationBox.innerHTML = `
    <h4>تعهد السائق</h4>
    <p>أتعهد بأن:</p>
    <ul style="text-align:right;">
      <li>جميع المعلومات المقدمة صحيحة ودقيقة</li>
      <li>سيارتي في حالة جيدة وصالحة للقيادة</li>
      <li>أحمل رخصة قيادة سارية المفعول</li>
      <li>سأقوم بتوفير خدمة آمنة ومهذبة للركاب</li>
      <li>سأحترم قوانين المرور وأنظمة السلامة</li>
    </ul>`;
  declarationBox.style.display = 'block';
}

/* تسجيل الخروج */
function logout() {
  if (window.currentUser) {
    window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), null).catch(()=>{});
  }
  window.currentUser = null; window.currentRole = null; localStorage.clear();
  showPage('loginPage');
}

/* مساعد: درج استماع Enter لإرسال الدردشة */
document.addEventListener('DOMContentLoaded', function() {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) chatInput.addEventListener('keypress', function(e){ if (e.key === 'Enter') sendMessage(); });
});

/* ===== فاحص الصور: نوع/حجم/أبعاد بسيطة =====
   يعيد Promise<boolean>
*/
function validateImageFile(file) {
  return new Promise((resolve) => {
    if (!file) return resolve(false);
    const allowed = ['image/jpeg','image/jpg','image/png'];
    if (!allowed.includes(file.type)) return resolve(false);
    const maxBytes = 5 * 1024 * 1024; // 5 MB
    if (file.size > maxBytes) return resolve(false);

    // تأكد من أن الأبعاد ليست صفرية وأن الصورة واضحة بدرجة بسيطة
    const fr = new FileReader();
    fr.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        // نطلب على الأقل عرض 200px وارتفاع 100px كحد أدنى للصورة المتوقعة
        if (img.width < 200 || img.height < 100) return resolve(false);
        return resolve(true);
      };
      img.onerror = function(){ return resolve(false); };
      img.src = e.target.result;
    };
    fr.onerror = function(){ resolve(false); };
    fr.readAsDataURL(file);
  });
}

/* ===== مساعدة لإلغاء XSS بسيط عند إدراج النص في HTML ===== */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
</script>
</body>
</html>
