
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRASIAS - \u062e\u062f\u0645\u0629 \u0627\u0644\u0646\u0642\u0644 \u0627\u0644\u0630\u0643\u064a\u0629</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      direction: rtl;
    }
    
    .page {
      display: none;
      width: 100%;
      height: 100vh;
    }
    
    .page.active {
      display: flex;
    }
    
    .login-container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    
    .box {
      background: white;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.2);
      width: 100%;
      text-align: center;
      animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    h1, h2, h3 { 
      margin-bottom: 25px; 
      color: #4a5568; 
      font-weight: 600;
    }
    
    input, button, textarea, select {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .choice { 
      text-align: right; 
      margin: 25px 0; 
    }
    
    .choice label { 
      display: flex;
      align-items: center;
      margin-bottom: 12px; 
      font-size: 16px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    
    .choice label:hover {
      background-color: #f7fafc;
    }
    
    .choice input[type="radio"] {
      width: auto;
      margin-left: 10px;
      margin-bottom: 0;
    }
    
    .file-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }
    
    .file-input-label {
      display: block;
      padding: 15px;
      background: #f8f9fa;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .file-input-label:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .success-message, .error-message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    .success-message {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .error-message {
      background: #fed7d7;
      color: #742a2a;
    }
    
    #mapPage {
      flex-direction: row;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    #map { 
      width: 65%; 
      height: 100vh; 
    }
    
    .sidebar {
      width: 35%;
      background: #fff;
      padding: 30px;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .sidebar label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      text-align: right;
    }
    
    .driver-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .driver-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .driver-card.selected {
      border-color: #48bb78;
      background: #f0fff4;
    }

    .driver-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .driver-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .driver-distance {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .car-info {
      color: #718096;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .driver-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .call-btn {
      background: #48bb78;
      color: white;
    }

    .call-btn:hover {
      background: #38a169;
    }

    .chat-btn {
      background: #4299e1;
      color: white;
    }

    .chat-btn:hover {
      background: #3182ce;
    }

    .select-btn {
      background: #667eea;
      color: white;
    }

    .select-btn:hover {
      background: #5a67d8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-right: 4px solid #667eea;
      z-index: 1000;
      max-width: 350px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .notification-content {
      color: #4a5568;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .notification-actions {
      display: flex;
      gap: 10px;
    }

    .accept-btn, .reject-btn {
      flex: 1;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .accept-btn {
      background: #48bb78;
      color: white;
    }

    .reject-btn {
      background: #e53e3e;
      color: white;
    }

    .chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }

    .chat-header {
      background: #667eea;
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      max-height: 250px;
    }

    .chat-input-container {
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 0;
    }

    .send-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin: 0;
      width: auto;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
    }

    .message.sent {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: left;
    }

    .message.received {
      background: #f7fafc;
      color: #2d3748;
      margin-right: auto;
    }

    .trip-status {
      background: #e6fffa;
      border: 1px solid #81e6d9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .trip-status.active {
      background: #f0fff4;
      border-color: #9ae6b4;
    }

    @media (max-width: 768px) {
      #mapPage {
        flex-direction: column;
      }
      
      #map {
        width: 100%;
        height: 60vh;
      }
      
      .sidebar {
        width: 100%;
        height: 40vh;
        padding: 20px;
      }
      
      .box {
        margin: 10px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- \u0635\u0641\u062d\u0629 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644 -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="box">
        <h1>\ud83d\ude96 GRASIAS</h1>
        <h2>\u0645\u0631\u062d\u0628\u0627\u064b \u0628\u0643 \u0641\u064a \u062e\u062f\u0645\u0629 \u0627\u0644\u0646\u0642\u0644 \u0627\u0644\u0630\u0643\u064a\u0629</h2>
        <div class="choice">
          <label>
            <input type="radio" name="role" value="sayeq"> 
            <span>\ud83d\ude97 \u0633\u0627\u0626\u0642</span>
          </label>
          <label>
            <input type="radio" name="role" value="rakib"> 
            <span>\ud83e\uddcd\u200d\u2640\ufe0f \u0631\u0627\u0643\u0628</span>
          </label>
        </div>
        <button onclick="signInWithGoogle()">\ud83d\udd10 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644 \u0628\u0627\u0633\u062a\u062e\u062f\u0627\u0645 Google</button>
      </div>
    </div>
  </div>

  <!-- \u0635\u0641\u062d\u0629 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0631\u0627\u0643\u0628 -->
  <div id="passengerPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>\u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0631\u0627\u0643\u0628</h2>
        <div class="success-message" id="passengerSuccess"></div>
        <div class="error-message" id="passengerError"></div>
        
        <input type="text" id="passengerName" placeholder="\u0627\u0644\u0627\u0633\u0645 \u0627\u0644\u0643\u0627\u0645\u0644" required>
        <input type="tel" id="passengerPhone" placeholder="\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062a\u0641 (\u0645\u062b\u0627\u0644: 0612345678)" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="passengerIdCard" accept="image/*" />
          <label for="passengerIdCard" class="file-input-label">
            \ud83d\udcc4 \u0627\u062e\u062a\u0631 \u0635\u0648\u0631\u0629 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0647\u0648\u064a\u0629
          </label>
        </div>
        
        <button onclick="submitPassengerInfo()">\u0645\u062a\u0627\u0628\u0639\u0629 \u27a1\ufe0f</button>
      </div>
    </div>
  </div>

  <!-- \u0635\u0641\u062d\u0629 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0633\u0627\u0626\u0642 -->
  <div id="driverPage" class="page">
    <div class="login-container">
      <div class="box">
        <h2>\u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0633\u0627\u0626\u0642</h2>
        <div class="success-message" id="driverSuccess"></div>
        <div class="error-message" id="driverError"></div>
        
        <input type="text" id="driverName" placeholder="\u0627\u0644\u0627\u0633\u0645 \u0627\u0644\u0643\u0627\u0645\u0644" required>
        <input type="tel" id="driverPhone" placeholder="\u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062a\u0641 (\u0645\u062b\u0627\u0644: 0612345678)" required>
        <input type="text" id="carType" placeholder="\u0646\u0648\u0639 \u0627\u0644\u0633\u064a\u0627\u0631\u0629 (\u0645\u062b\u0627\u0644: \u062a\u0648\u064a\u0648\u062a\u0627 \u0643\u0648\u0631\u0648\u0644\u0627)" required>
        <input type="text" id="carColor" placeholder="\u0644\u0648\u0646 \u0627\u0644\u0633\u064a\u0627\u0631\u0629" required>
        <input type="text" id="plateNumber" placeholder="\u0631\u0642\u0645 \u0644\u0648\u062d\u0629 \u0627\u0644\u0633\u064a\u0627\u0631\u0629" required>
        
        <div class="file-input-wrapper">
          <input type="file" id="driverId" accept="image/*" required>
          <label for="driverId" class="file-input-label">
            \ud83d\udcc4 \u0627\u062e\u062a\u0631 \u0635\u0648\u0631\u0629 \u0628\u0637\u0627\u0642\u0629 \u0627\u0644\u0647\u0648\u064a\u0629
          </label>
        </div>
        
        <div class="file-input-wrapper">
          <input type="file" id="carCheck" accept="image/*" required>
          <label for="carCheck" class="file-input-label">
            \ud83d\udd27 \u0627\u062e\u062a\u0631 \u0635\u0648\u0631\u0629 \u0627\u0644\u062a\u0634\u062e\u064a\u0635 \u0627\u0644\u062a\u0642\u0646\u064a
          </label>
        </div>
        
        <button onclick="showDeclaration()">\ud83d\udcdc \u0639\u0631\u0636 \u0627\u0644\u062a\u0639\u0647\u062f</button>
        <div class="declaration-box" id="declarationBox" style="display: none; text-align: right;"></div>
        <button onclick="startDriverMap()">\u0645\u062a\u0627\u0628\u0639\u0629 \u27a1\ufe0f</button>
      </div>
    </div>
  </div>

  <!-- \u0635\u0641\u062d\u0629 \u0627\u0644\u062e\u0631\u064a\u0637\u0629 -->
  <div id="mapPage" class="page">
    <div id="map"></div>
    <div class="sidebar">
      <h3 id="sidebarTitle">\ud83d\ude97 \u062a\u0641\u0627\u0635\u064a\u0644 \u0627\u0644\u0631\u062d\u0644\u0629</h3>
      
      <!-- \u0645\u062d\u062a\u0648\u0649 \u0627\u0644\u0631\u0627\u0643\u0628 -->
      <div id="passengerContent" style="display: none;">
        <label>\u0627\u0644\u0648\u062c\u0647\u0629:</label>
        <input type="text" id="destination" placeholder="\u0623\u062f\u062e\u0644 \u0648\u062c\u0647\u062a\u0643 (\u0645\u062b\u0627\u0644: \u062c\u0627\u0645\u0639\u0629 \u0627\u0644\u062c\u0632\u0627\u0626\u0631)">
        
        <label>\u0639\u062f\u062f \u0627\u0644\u0631\u0643\u0627\u0628:</label>
        <input type="number" id="passengers" min="1" max="8" placeholder="\u0639\u062f\u062f \u0627\u0644\u0631\u0643\u0627\u0628" value="1">
        
        <label>\u0645\u0644\u0627\u062d\u0638\u0627\u062a \u0625\u0636\u0627\u0641\u064a\u0629:</label>
        <textarea id="notes" placeholder="\u0623\u064a \u0645\u0644\u0627\u062d\u0638\u0627\u062a \u062e\u0627\u0635\u0629..." style="height: 80px; resize: vertical;"></textarea>
        
        <div id="nearbyDrivers">
          <h4>\u0627\u0644\u0633\u0627\u0626\u0642\u0648\u0646 \u0627\u0644\u0642\u0631\u064a\u0628\u0648\u0646:</h4>
          <div id="driversList"></div>
        </div>
      </div>

      <!-- \u0645\u062d\u062a\u0648\u0649 \u0627\u0644\u0633\u0627\u0626\u0642 -->
      <div id="driverContent" style="display: none;">
        <label>\u062d\u0627\u0644\u0629 \u0627\u0644\u0633\u0627\u0626\u0642:</label>
        <select id="driverStatus" onchange="updateDriverStatus()">
          <option value="available">\u0645\u062a\u0627\u062d</option>
          <option value="busy">\u0645\u0634\u063a\u0648\u0644</option>
          <option value="offline">\u063a\u064a\u0631 \u0645\u062a\u0635\u0644</option>
        </select>
        
        <label>\u0639\u062f\u062f \u0627\u0644\u0645\u0642\u0627\u0639\u062f \u0627\u0644\u0645\u062a\u0627\u062d\u0629:</label>
        <input type="number" id="availableSeats" min="1" max="8" value="4">
        
        <label>\u0645\u0644\u0627\u062d\u0638\u0627\u062a \u0627\u0644\u0633\u0627\u0626\u0642:</label>
        <textarea id="driverNotes" placeholder="\u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0625\u0636\u0627\u0641\u064a\u0629 \u0644\u0644\u0631\u0643\u0627\u0628..." style="height: 60px;"></textarea>
      </div>
      
      <button onclick="activateRide()" id="activateBtn">\ud83d\ude97 \u062a\u0641\u0639\u064a\u0644 \u0627\u0644\u0631\u062d\u0644\u0629</button>
      <button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">\ud83d\udeaa \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062e\u0631\u0648\u062c</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // \u0625\u0639\u062f\u0627\u062f Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
      authDomain: "grasias-d7830.firebaseapp.com",
      databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "grasias-d7830",
      storageBucket: "grasias-d7830.appspot.com",
      messagingSenderId: "134413476604",
      appId: "1:134413476604:web:ab1acfa69c025218cbad79",
      measurementId: "G-6QBYM41CJ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // \u0645\u062a\u063a\u064a\u0631\u0627\u062a \u0639\u0627\u0645\u0629
    let currentUser = null;
    let currentRole = null;
    let currentMap = null;
    let currentMarker = null;
    let currentLocation = null;
    let selectedDriver = null;
    let currentTrip = null;
    let locationInterval = null;

    // \u062c\u0639\u0644 \u0627\u0644\u0645\u062a\u063a\u064a\u0631\u0627\u062a \u0645\u062a\u0627\u062d\u0629 \u0639\u0627\u0644\u0645\u064a\u0627\u064b
    window.db = db;
    window.auth = auth;

    // \u0639\u0631\u0636 \u0627\u0644\u0635\u0641\u062d\u0627\u062a
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }
    window.showPage = showPage;

    // \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644 \u0628\u062c\u0648\u062c\u0644
    window.signInWithGoogle = () => {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("\u064a\u0631\u062c\u0649 \u0627\u062e\u062a\u064a\u0627\u0631 \u0627\u0644\u062f\u0648\u0631 \u0642\u0628\u0644 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644");
        return;
      }
      
      currentRole = roleInput.value;

      signInWithPopup(auth, provider)
        .then((result) => {
          currentUser = result.user;
          
          // \u0627\u0644\u062a\u062d\u0642\u0642 \u0645\u0646 \u0648\u062c\u0648\u062f \u0628\u064a\u0627\u0646\u0627\u062a \u0627\u0644\u0645\u0633\u062a\u062e\u062f\u0645
          const userRef = ref(db, `users/${currentUser.uid}`);
          get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const userData = snapshot.val();
              if (userData.profileComplete) {
                showPage("mapPage");
                loadMap(userData.fullName || currentUser.displayName);
              } else {
                if (userData.role === "rakib") {
                  showPage("passengerPage");
                } else {
                  showPage("driverPage");
                }
              }
            } else {
              // \u0625\u0646\u0634\u0627\u0621 \u062d\u0633\u0627\u0628 \u062c\u062f\u064a\u062f
              set(userRef, {
                name: currentUser.displayName,
                email: currentUser.email,
                role: currentRole,
                createdAt: new Date().toISOString(),
                profileComplete: false
              });
              
              if (currentRole === "rakib") {
                showPage("passengerPage");
              } else {
                showPage("driverPage");
              }
            }
          });
        })
        .catch((error) => {
          console.error("\u062e\u0637\u0623 \u0641\u064a \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644:", error);
          alert("\u0641\u0634\u0644 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644: " + error.message);
        });
    };

    // \u062a\u062d\u0645\u064a\u0644 \u0627\u0644\u062e\u0631\u064a\u0637\u0629
    function loadMap(userName) {
      if (currentMap) {
        currentMap.remove();
      }
      
      currentMap = L.map('map').setView([36.7538, 3.0588], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '\u00a9 OpenStreetMap contributors'
      }).addTo(currentMap);

      // \u062a\u062e\u0635\u064a\u0635 \u0627\u0644\u0645\u062d\u062a\u0648\u0649 \u062d\u0633\u0628 \u0646\u0648\u0639 \u0627\u0644\u0645\u0633\u062a\u062e\u062f\u0645
      if (currentRole === 'rakib') {
        document.getElementById('passengerContent').style.display = 'block';
        document.getElementById('driverContent').style.display = 'none';
        document.getElementById('sidebarTitle').textContent = '\ud83e\uddcd\u200d\u2640\ufe0f \u0637\u0644\u0628 \u0631\u062d\u0644\u0629';
        document.getElementById('activateBtn').textContent = '\ud83d\udd0d \u0627\u0644\u0628\u062d\u062b \u0639\u0646 \u0633\u0627\u0626\u0642';
      } else {
        document.getElementById('passengerContent').style.display = 'none';
        document.getElementById('driverContent').style.display = 'block';
        document.getElementById('sidebarTitle').textContent = '\ud83d\ude97 \u0644\u0648\u062d\u0629 \u0627\u0644\u0633\u0627\u0626\u0642';
        document.getElementById('activateBtn').textContent = '\ud83d\ude97 \u062a\u0641\u0639\u064a\u0644 \u0627\u0644\u062e\u062f\u0645\u0629';
      }

      // \u0627\u0644\u062d\u0635\u0648\u0644 \u0639\u0644\u0649 \u0627\u0644\u0645\u0648\u0642\u0639 \u0627\u0644\u062d\u0627\u0644\u064a
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          currentLocation = { lat, lng };
          
          currentMap.setView([lat, lng], 14);
          
          // \u0625\u0636\u0627\u0641\u0629 \u0639\u0644\u0627\u0645\u0629 \u0627\u0644\u0645\u0648\u0642\u0639
          const icon = currentRole === 'rakib' ? '\ud83e\uddcd\u200d\u2640\ufe0f' : '\ud83d\ude97';
          const marker = L.marker([lat, lng], {
            icon: L.divIcon({
              html: icon,
              iconSize: [30, 30],
              className: 'custom-div-icon'
            })
          }).addTo(currentMap)
            .bindPopup(`\ud83d\udccd ${userName}`)
            .openPopup();
            
          currentMarker = marker;
          
          // \u0628\u062f\u0621 \u062a\u062a\u0628\u0639 \u0627\u0644\u0645\u0648\u0642\u0639
          startLocationTracking();
          
          // \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0645\u0648\u0642\u0639 \u0641\u064a \u0642\u0627\u0639\u062f\u0629 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a
          updateLocationInDB(lat, lng);
          
        }, (error) => {
          console.error("\u062e\u0637\u0623 \u0641\u064a \u062a\u062d\u062f\u064a\u062f \u0627\u0644\u0645\u0648\u0642\u0639:", error);
          alert("\u26a0\ufe0f \u062a\u0639\u0630\u0631 \u062a\u062d\u062f\u064a\u062f \u0645\u0648\u0642\u0639\u0643. \u064a\u0631\u062c\u0649 \u0627\u0644\u062a\u0623\u0643\u062f \u0645\u0646 \u062a\u0641\u0639\u064a\u0644 \u062e\u062f\u0645\u0629 \u0627\u0644\u0645\u0648\u0642\u0639.");
        });
      } else {
        alert("\u26a0\ufe0f \u0627\u0644\u0645\u062a\u0635\u0641\u062d \u0644\u0627 \u064a\u062f\u0639\u0645 \u062a\u062d\u062f\u064a\u062f \u0627\u0644\u0645\u0648\u0642\u0639.");
      }
    }
    window.loadMap = loadMap;

    // \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0645\u0648\u0642\u0639 \u0641\u064a \u0642\u0627\u0639\u062f\u0629 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a
    function updateLocationInDB(lat, lng) {
      if (!currentUser) return;
      
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      const status = currentRole === 'sayeq' ? 
        (document.getElementById('driverStatus')?.value || 'available') : 'active';
      
      set(locationRef, {
        lat: lat,
        lng: lng,
        role: currentRole,
        name: currentUser.displayName,
        timestamp: Date.now(),
        status: status
      });
    }

    // \u062a\u062a\u0628\u0639 \u0627\u0644\u0645\u0648\u0642\u0639 \u0627\u0644\u0645\u0628\u0627\u0634\u0631
    function startLocationTracking() {
      if (!currentUser) return;
      
      if (locationInterval) {
        clearInterval(locationInterval);
      }
      
      locationInterval = setInterval(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            currentLocation = { lat, lng };
            
            // \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0645\u0648\u0642\u0639 \u0641\u064a \u0642\u0627\u0639\u062f\u0629 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a
            updateLocationInDB(lat, lng);
            
            // \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0639\u0644\u0627\u0645\u0629 \u0639\u0644\u0649 \u0627\u0644\u062e\u0631\u064a\u0637\u0629
            if (currentMarker) {
              currentMarker.setLatLng([lat, lng]);
            }
            
            // \u062a\u062d\u062f\u064a\u062b \u0642\u0627\u0626\u0645\u0629 \u0627\u0644\u0633\u0627\u0626\u0642\u064a\u0646 \u0623\u0648 \u0627\u0644\u0631\u0643\u0627\u0628
            if (currentRole === 'rakib') {
              updateNearbyDrivers();
            }
          });
        }
      }, 10000); // \u062a\u062d\u062f\u064a\u062b \u0643\u0644 10 \u062b\u0648\u0627\u0646\u064a
    }

    // \u062a\u062d\u062f\u064a\u062b \u0627\u0644\u0633\u0627\u0626\u0642\u064a\u0646 \u0627\u0644\u0642\u0631\u064a\u0628\u064a\u0646
    function updateNearbyDrivers() {
      if (!currentLocation || currentRole !== 'rakib') return;
      
      const locationsRef = ref(db, 'locations');
      onValue(locationsRef, (snapshot) => {
        const locations = snapshot.val();
        const driversList = document.getElementById('driversList');
        
        if (!driversList || !locations) return;
        
        const nearbyDrivers = [];
        Object.keys(locations).forEach(userId => {
          const location = locations[userId];
          if (location.role === 'sayeq' && location.status === 'available' && userId !== currentUser.uid) {
            const distance = calculateDistance(currentLocation, location);
            if (distance <= 10) { // \u0646\u0637\u0627\u0642 10 \u0643\u0645
              nearbyDrivers.push({ userId, location, distance });
            }
          }
        });
        
        // \u062a\u0631\u062a\u064a\u0628 \u062d\u0633\u0628 \u0627\u0644\u0645\u0633\u0627\u0641\u0629
        nearbyDrivers.sort((a, b) => a.distance - b.distance);
        
        driversList.innerHTML = '';
        if (nearbyDrivers.length === 0) {
          driversList.innerHTML = '<p style="text-align: center; color: #718096;">\u0644\u0627 \u064a\u0648\u062c\u062f \u0633\u0627\u0626\u0642\u0648\u0646 \u0645\u062a\u0627\u062d\u0648\u0646 \u0641\u064a \u0627\u0644\u0645\u0646\u0637\u0642\u0629</p>';
          return;
        }
        
        nearbyDrivers.forEach(({ userId, location, distance }) => {
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          driverCard.innerHTML = `
            <div class="driver-info">
              <div class="driver-name">\ud83d\ude97 ${location.name}</div>
              <div class="driver-distance">${distance.toFixed(1)} \u0643\u0645</div>
            </div>
            <div class="car-info">
              <div>\ud83d\udcf1 \u0645\u062a\u0627\u062d \u0644\u0644\u062a\u0648\u0627\u0635\u0644</div>
            </div>
            <div class="driver-actions">
              <button class="action-btn chat-btn" onclick="selectDriver('${userId}', '${location.name}', ${distance})">\u0627\u062e\u062a\u064a\u0627\u0631</button>
            </div>
          `;
          driversList.appendChild(driverCard);
        });
      });
    }

    // \u062d\u0633\u0627\u0628 \u0627\u0644\u0645\u0633\u0627\u0641\u0629 \u0628\u064a\u0646 \u0646\u0642\u0637\u062a\u064a\u0646
    function calculateDistance(pos1, pos2) {
      const R = 6371;
      const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
      const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // \u0627\u062e\u062a\u064a\u0627\u0631 \u0627\u0644\u0633\u0627\u0626\u0642
    window.selectDriver = (driverId, driverName, distance) => {
      if (!currentUser || !currentLocation) return;
      
      const destination = document.getElementById('destination').value.trim();
      const passengers = document.getElementById('passengers').value;
      const notes = document.getElementById('notes').value.trim();
      
      if (!destination) {
        alert('\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0648\u062c\u0647\u0629 \u0623\u0648\u0644\u0627\u064b');
        return;
      }
      
      if (!passengers || passengers < 1 || passengers > 8) {
        alert('\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0639\u062f\u062f \u0635\u062d\u064a\u062d \u0644\u0644\u0631\u0643\u0627\u0628 (1-8)');
        return;
      }
      
      // \u0625\u0646\u0634\u0627\u0621 \u0637\u0644\u0628 \u0631\u062d\u0644\u0629
      const tripRequest = {
        passengerId: currentUser.uid,
        passengerName: currentUser.displayName,
        driverId: driverId,
        driverName: driverName,
        destination: destination,
        passengers: parseInt(passengers),
        notes: notes,
        distance: distance.toFixed(1),
        status: 'pending',
        timestamp: Date.now(),
        passengerLocation: currentLocation
      };
      
      const tripRef = push(ref(db, 'tripRequests'));
      set(tripRef, tripRequest).then(() => {
        alert(`\u062a\u0645 \u0625\u0631\u0633\u0627\u0644 \u0637\u0644\u0628 \u0627\u0644\u0631\u062d\u0644\u0629 \u0625\u0644\u0649 \u0627\u0644\u0633\u0627\u0626\u0642 ${driverName}`);
        
        // \u0645\u0631\u0627\u0642\u0628\u0629 \u062d\u0627\u0644\u0629 \u0627\u0644\u0637\u0644\u0628
        onValue(tripRef, (snapshot) => {
          const trip = snapshot.val();
          if (trip && trip.status === 'accepted') {
            alert(`\ud83c\udf89 \u062a\u0645 \u0642\u0628\u0648\u0644 \u0637\u0644\u0628\u0643 \u0645\u0646 ${driverName}!`);
            currentTrip = { id: tripRef.key, data: trip };
          } else if (trip && trip.status === 'rejected') {
            alert(`\u062a\u0645 \u0631\u0641\u0636 \u0627\u0644\u0637\u0644\u0628 \u0645\u0646 ${driverName}`);
            currentTrip = null;
          }
        });
      });
    };

    // \u062a\u062d\u062f\u064a\u062b \u062d\u0627\u0644\u0629 \u0627\u0644\u0633\u0627\u0626\u0642
    window.updateDriverStatus = () => {
      if (!currentUser || currentRole !== 'sayeq') return;
      
      const status = document.getElementById('driverStatus').value;
      const locationRef = ref(db, `locations/${currentUser.uid}`);
      
      get(locationRef).then((snapshot) => {
        if (snapshot.exists()) {
          set(locationRef, {
            ...snapshot.val(),
            status: status,
            updatedAt: Date.now()
          });
        }
      });
    };

    // \u0627\u0644\u062a\u062d\u0642\u0642 \u0645\u0646 \u0631\u0642\u0645 \u0627\u0644\u0647\u0627\u062a\u0641
    function validatePhone(phone) {
      const phoneRegex = /^(06|07|05)\d{8}$/;
      return phoneRegex.test(phone);
    }

    // \u062d\u0641\u0638 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0631\u0627\u0643\u0628
    window.submitPassengerInfo = () => {
      const name = document.getElementById("passengerName").value.trim();
      const phone = document.getElementById("passengerPhone").value.trim();
      
      if (!name) {
        document.getElementById("passengerError").textContent = "\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0627\u0633\u0645 \u0627\u0644\u0643\u0627\u0645\u0644";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      if (!phone || !validatePhone(phone)) {
        document.getElementById("passengerError").textContent = "\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0631\u0642\u0645 \u0647\u0627\u062a\u0641 \u0635\u062d\u064a\u062d";
        document.getElementById("passengerError").style.display = "block";
        return;
      }
      
      // \u062d\u0641\u0638 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0631\u0627\u0643\u0628
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        profileComplete: true
      }).then(() => {
        document.getElementById("passengerSuccess").textContent = "\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0628\u0646\u062c\u0627\u062d!";
        document.getElementById("passengerSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // \u062d\u0641\u0638 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0633\u0627\u0626\u0642
    window.startDriverMap = () => {
      const name = document.getElementById("driverName").value.trim();
      const phone = document.getElementById("driverPhone").value.trim();
      const carType = document.getElementById("carType").value.trim();
      const carColor = document.getElementById("carColor").value.trim();
      const plateNumber = document.getElementById("plateNumber").value.trim();
      
      if (!name || !phone || !carType || !carColor || !plateNumber) {
        document.getElementById("driverError").textContent = "\u064a\u0631\u062c\u0649 \u0645\u0644\u0621 \u062c\u0645\u064a\u0639 \u0627\u0644\u062d\u0642\u0648\u0644 \u0627\u0644\u0645\u0637\u0644\u0648\u0628\u0629";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      if (!validatePhone(phone)) {
        document.getElementById("driverError").textContent = "\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0631\u0642\u0645 \u0647\u0627\u062a\u0641 \u0635\u062d\u064a\u062d";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      // \u062d\u0641\u0638 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0627\u0644\u0633\u0627\u0626\u0642
      const userRef = ref(db, `users/${currentUser.uid}`);
      set(userRef, {
        ...currentUser,
        fullName: name,
        phone: phone,
        carType: carType,
        carColor: carColor,
        plateNumber: plateNumber,
        profileComplete: true
      }).then(() => {
        document.getElementById("driverSuccess").textContent = "\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0628\u0646\u062c\u0627\u062d!";
        document.getElementById("driverSuccess").style.display = "block";
        
        setTimeout(() => {
          showPage("mapPage");
          loadMap(name);
        }, 1500);
      });
    };

    // \u0639\u0631\u0636 \u0627\u0644\u062a\u0639\u0647\u062f
    window.showDeclaration = () => {
      const name = document.getElementById("driverName").value.trim();
      if (!name) {
        document.getElementById("driverError").textContent = "\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0627\u0633\u0645 \u0623\u0648\u0644\u0627\u064b";
        document.getElementById("driverError").style.display = "block";
        return;
      }
      
      const declarationBox = document.getElementById("declarationBox");
      declarationBox.style.display = "block";
      declarationBox.innerHTML = `
        <h4>\u062a\u0639\u0647\u062f \u0627\u0644\u0633\u0627\u0626\u0642</h4>
        <p>\u0623\u0646\u0627 \u0627\u0644\u0645\u062a\u0639\u0647\u062f \u0627\u0644\u0633\u064a\u062f/\u0629 <strong>${name}</strong> \u0623\u0642\u0631 \u0648\u0623\u062a\u0639\u0647\u062f \u0628\u0645\u0627 \u064a\u0644\u064a:</p>
        <ul style="text-align: right; line-height: 1.8;">
          <li>\u0627\u0644\u0627\u0644\u062a\u0632\u0627\u0645 \u0628\u0642\u0648\u0627\u0646\u064a\u0646 \u0627\u0644\u0645\u0631\u0648\u0631 \u0648\u0627\u0644\u0633\u0644\u0627\u0645\u0629 \u0627\u0644\u0639\u0627\u0645\u0629</li>
          <li>\u0627\u0644\u0645\u062d\u0627\u0641\u0638\u0629 \u0639\u0644\u0649 \u0633\u0644\u0627\u0645\u0629 \u0627\u0644\u0631\u0643\u0627\u0628</li>
          <li>\u0639\u062f\u0645 \u0627\u0644\u0642\u064a\u0627\u062f\u0629 \u062a\u062d\u062a \u062a\u0623\u062b\u064a\u0631 \u0623\u064a \u0645\u0648\u0627\u062f \u0645\u062e\u062f\u0631\u0629 \u0623\u0648 \u0643\u062d\u0648\u0644\u064a\u0629</li>
          <li>\u0627\u0644\u0627\u0644\u062a\u0632\u0627\u0645 \u0628\u0627\u0644\u0623\u0633\u0639\u0627\u0631 \u0627\u0644\u0645\u062d\u062f\u062f\u0629 \u0645\u0646 \u0642\u0628\u0644 \u0627\u0644\u0645\u0646\u0635\u0629</li>
          <li>\u0627\u0644\u062a\u0639\u0627\u0645\u0644 \u0628\u0623\u062f\u0628 \u0648\u0627\u062d\u062a\u0631\u0627\u0645 \u0645\u0639 \u062c\u0645\u064a\u0639 \u0627\u0644\u0631\u0643\u0627\u0628</li>
        </ul>
        <p><strong>\u0627\u0644\u062a\u0648\u0642\u064a\u0639:</strong> ${name}</p>
        <p><strong>\u0627\u0644\u062a\u0627\u0631\u064a\u062e:</strong> ${new Date().toLocaleDateString('ar-DZ')}</p>
      `;
    };

    // \u062a\u0641\u0639\u064a\u0644 \u0627\u0644\u0631\u062d\u0644\u0629
    window.activateRide = () => {
      if (currentRole === 'rakib') {
        const destination = document.getElementById("destination").value.trim();
        const passengers = document.getElementById("passengers").value;
        
        if (!destination) {
          alert("\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0627\u0644\u0648\u062c\u0647\u0629");
          return;
        }
        
        if (!passengers || passengers < 1 || passengers > 8) {
          alert("\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0639\u062f\u062f \u0635\u062d\u064a\u062d \u0644\u0644\u0631\u0643\u0627\u0628 (1-8)");
          return;
        }
        
        alert(`\ud83d\udd0d \u062c\u0627\u0631\u064a \u0627\u0644\u0628\u062d\u062b \u0639\u0646 \u0633\u0627\u0626\u0642\u064a\u0646 \u0645\u062a\u0627\u062d\u064a\u0646 \u0641\u064a \u0645\u0646\u0637\u0642\u062a\u0643...`);
        updateNearbyDrivers();
      } else {
        // \u062a\u0641\u0639\u064a\u0644 \u062e\u062f\u0645\u0629 \u0627\u0644\u0633\u0627\u0626\u0642
        const availableSeats = document.getElementById("availableSeats").value;
        const driverNotes = document.getElementById("driverNotes").value.trim();
        
        if (!availableSeats || availableSeats < 1 || availableSeats > 8) {
          alert("\u064a\u0631\u062c\u0649 \u0625\u062f\u062e\u0627\u0644 \u0639\u062f\u062f \u0635\u062d\u064a\u062d \u0644\u0644\u0645\u0642\u0627\u0639\u062f \u0627\u0644\u0645\u062a\u0627\u062d\u0629 (1-8)");
          return;
        }
        
        // \u062a\u062d\u062f\u064a\u062b \u062d\u0627\u0644\u0629 \u0627\u0644\u0633\u0627\u0626\u0642
        updateDriverStatus();
        alert(`\ud83d\ude97 \u062a\u0645 \u062a\u0641\u0639\u064a\u0644 \u062e\u062f\u0645\u062a\u0643 \u0628\u0646\u062c\u0627\u062d! \u0623\u0646\u062a \u0627\u0644\u0622\u0646 \u0645\u062a\u0627\u062d \u0644\u0644\u0631\u0643\u0627\u0628.`);
      }
    };

    // \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062e\u0631\u0648\u062c
    window.logout = () => {
      if (confirm("\u0647\u0644 \u0623\u0646\u062a \u0645\u062a\u0623\u0643\u062f \u0645\u0646 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062e\u0631\u0648\u062c\u061f")) {
        // \u0625\u064a\u0642\u0627\u0641 \u062a\u062a\u0628\u0639 \u0627\u0644\u0645\u0648\u0642\u0639
        if (locationInterval) {
          clearInterval(locationInterval);
          locationInterval = null;
        }
        
        // \u0625\u0632\u0627\u0644\u0629 \u0627\u0644\u0645\u0648\u0642\u0639 \u0645\u0646 \u0642\u0627\u0639\u062f\u0629 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a
        if (currentUser) {
          const locationRef = ref(db, `locations/${currentUser.uid}`);
          set(locationRef, null);
        }
        
        // \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062e\u0631\u0648\u062c
        signOut(auth).then(() => {
          currentUser = null;
          currentRole = null;
          if (currentMap) {
            currentMap.remove();
            currentMap = null;
          }
          showPage("loginPage");
        });
      }
    };

    // \u062a\u062d\u0633\u064a\u0646 \u062a\u062c\u0631\u0628\u0629 \u0631\u0641\u0639 \u0627\u0644\u0645\u0644\u0641\u0627\u062a
    document.addEventListener('DOMContentLoaded', function() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('change', function() {
          const label = document.querySelector(`label[for="${this.id}"]`);
          if (this.files.length > 0) {
            label.style.borderColor = '#48bb78';
            label.style.backgroundColor = '#f0fff4';
            label.innerHTML = `\u2705 \u062a\u0645 \u0627\u062e\u062a\u064a\u0627\u0631 \u0627\u0644\u0645\u0644\u0641: ${this.files[0].name}`;
          }
        });
      });
    });
  </script>
</body>
</html>
